
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://quarkus.io/quarkus-workshop-langchain4j/section-2/step-06/">
      
      
        <link rel="prev" href="../step-05/">
      
      
        <link rel="next" href="../conclusion/">
      
      
        
      
      
      <link rel="icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Step 6 - Human-in-the-Loop pattern - Quarkus LangChain4j Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../extra.css">
    
      <link rel="stylesheet" href="../../assets/stylesheets/panzoom.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  <meta name="panzoom-theme" content="material">
<meta name="panzoom-data" content='{"selectors": [".mermaid", ".d2"], "initial_zoom_level": 1.0}'> </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#step-06-human-in-the-loop-pattern" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
You are not viewing the latest version.
<a href="../../..">
    <strong>Click here to go to latest.</strong>
</a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),base=new URL("../.."),outdated=__md_get("__outdated",sessionStorage,base);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Quarkus LangChain4j Workshop" class="md-header__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Quarkus LangChain4j Workshop
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Step 6 - Human-in-the-Loop pattern
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H6zm7-4.68V17c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-2.26C3.19 13.47 2 11.38 2 9c0-3.87 3.13-7 7-7 1.65 0 3.16.57 4.35 1.5C10.8 4.57 9 7.07 9 10c0 2.79 1.64 5.19 4 6.32m7.92-6.38-1.42-.91-1.4.97.4-1.65-1.33-1.03 1.68-.11.56-1.61.63 1.58 1.68.04-1.3 1.08zM19.39 13c-1.89 2.27-5.36 2.19-7.17-.05C10 10.13 11.56 6 15 5.34c.34-.05.64.29.5.63-.45 1.28-.38 2.74.35 4a4.62 4.62 0 0 0 3.27 2.28c.35.05.5.49.27.75"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6a6 6 0 0 1 6 6c0 2.22-1.21 4.16-3 5.2V19a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1v-1.8c-1.79-1.04-3-2.98-3-5.2a6 6 0 0 1 6-6m2 15v1a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1v-1zm6-10h3v2h-3zM1 11h3v2H1zM13 1v3h-2V1zM4.92 3.5l2.13 2.14-1.42 1.41L3.5 4.93zm12.03 2.13 2.12-2.13 1.43 1.43-2.13 2.12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Quarkus LangChain4j Workshop" class="md-nav__button md-logo" aria-label="Quarkus LangChain4j Workshop" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Quarkus LangChain4j Workshop
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/quarkusio/quarkus-langchain4j-workshop" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../requirements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Requirements
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Section 1 - AI Apps
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Section 1 - AI Apps
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 1 - Introduction to Quarkus LangChain4j
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 2 - Playing with model parameters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 3 - Streaming responses
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 4 - Using system messages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 5 - Introduction to the RAG pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-06/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 6 - Deconstructing the RAG
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-07/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 7 - Function calling and tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-08/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 8 - Model Context Protocol
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-09/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 9 - Guardrails
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../section-1/step-10/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 10 - Observability and Fault Tolerance
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Section 2 - Agentic Workflows
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Section 2 - Agentic Workflows
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 1 - Implementing AI Agents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 2 - Creating simple agentic workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 3 - Composing multiple agentic workflows
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 4 - Supervisor pattern for dynamic orchestration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../step-05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 5 - Using remote agents (A2A)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Step 6 - Human-in-the-Loop pattern
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Step 6 - Human-in-the-Loop pattern
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#human-in-the-loop-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Human-in-the-Loop Pattern
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-requirement-from-miles-of-smiles-management-human-approval-for-high-value-dispositions" class="md-nav__link">
    <span class="md-ellipsis">
      
        New Requirement from Miles of Smiles Management: Human Approval for High-Value Dispositions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-learn" class="md-nav__link">
    <span class="md-ellipsis">
      
        What You&rsquo;ll Learn
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding Human-in-the-Loop
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding Human-in-the-Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is Human-in-the-Loop?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hitl-vs-fully-autonomous" class="md-nav__link">
    <span class="md-ellipsis">
      
        HITL vs. Fully Autonomous
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-two-phase-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Two-Phase Workflow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-being-added" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is Being Added?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Being Added?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-complete-hitl-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Complete HITL Architecture
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-human-in-the-loop-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing the Human-in-the-Loop Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing the Human-in-the-Loop Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-dispositionproposalagent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the DispositionProposalAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-humanapprovalagent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the HumanApprovalAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-humanapprovaltool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the HumanApprovalTool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalservice" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalService
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalproposal-entity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalProposal Entity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalresource" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalResource
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-the-fleetsupervisoragent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update the FleetSupervisorAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-the-carconditions-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update the CarConditions Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-application-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update Application Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-the-complete-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try the Complete Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Try the Complete Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-application" class="md-nav__link">
    <span class="md-ellipsis">
      
        Start the Application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-hitl-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test HITL Scenarios
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test HITL Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-high-value-vehicle-requiring-approval" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 1: High-Value Vehicle Requiring Approval
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-high-value-vehicle-approval-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 2: High-Value Vehicle - Approval Rejected
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-3-low-value-vehicle-no-approval-needed" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 3: Low-Value Vehicle - No Approval Needed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check the Logs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-human-in-the-loop-matters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Human-in-the-Loop Matters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Human-in-the-Loop Matters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safety-and-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Safety and Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-and-audit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance and Audit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balancing-automation-and-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Balancing Automation and Control
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-implement-it-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optional: Implement It Yourself
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optional: Implement It Yourself">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-further" class="md-nav__link">
    <span class="md-ellipsis">
      
        Experiment Further
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experiment Further">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-implement-real-human-approval" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Implement Real Human Approval
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-add-approval-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Add Approval Workflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-track-approval-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Track Approval Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-implement-approval-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Implement Approval Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-add-approval-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Add Approval History
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      
        What&rsquo;s Next?
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conclusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mastering Agentic Systems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../conclusion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Conclusion
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#human-in-the-loop-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Human-in-the-Loop Pattern
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#new-requirement-from-miles-of-smiles-management-human-approval-for-high-value-dispositions" class="md-nav__link">
    <span class="md-ellipsis">
      
        New Requirement from Miles of Smiles Management: Human Approval for High-Value Dispositions
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-youll-learn" class="md-nav__link">
    <span class="md-ellipsis">
      
        What You&rsquo;ll Learn
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#understanding-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        Understanding Human-in-the-Loop
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Understanding Human-in-the-Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-is-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is Human-in-the-Loop?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hitl-vs-fully-autonomous" class="md-nav__link">
    <span class="md-ellipsis">
      
        HITL vs. Fully Autonomous
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-two-phase-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Two-Phase Workflow
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#what-is-being-added" class="md-nav__link">
    <span class="md-ellipsis">
      
        What is Being Added?
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="What is Being Added?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-complete-hitl-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Complete HITL Architecture
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementing-the-human-in-the-loop-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementing the Human-in-the-Loop Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementing the Human-in-the-Loop Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-the-dispositionproposalagent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the DispositionProposalAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-humanapprovalagent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the HumanApprovalAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-humanapprovaltool" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the HumanApprovalTool
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalservice" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalService
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalproposal-entity" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalProposal Entity
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-the-approvalresource" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create the ApprovalResource
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-the-fleetsupervisoragent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update the FleetSupervisorAgent
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-the-carconditions-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update the CarConditions Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update-application-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Update Application Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#try-the-complete-solution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Try the Complete Solution
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Try the Complete Solution">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#start-the-application" class="md-nav__link">
    <span class="md-ellipsis">
      
        Start the Application
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#test-hitl-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      
        Test HITL Scenarios
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Test HITL Scenarios">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scenario-1-high-value-vehicle-requiring-approval" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 1: High-Value Vehicle Requiring Approval
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-2-high-value-vehicle-approval-rejected" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 2: High-Value Vehicle - Approval Rejected
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scenario-3-low-value-vehicle-no-approval-needed" class="md-nav__link">
    <span class="md-ellipsis">
      
        Scenario 3: Low-Value Vehicle - No Approval Needed
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#check-the-logs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check the Logs
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-human-in-the-loop-matters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Why Human-in-the-Loop Matters
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Why Human-in-the-Loop Matters">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#safety-and-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Safety and Control
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compliance-and-audit" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compliance and Audit
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#balancing-automation-and-control" class="md-nav__link">
    <span class="md-ellipsis">
      
        Balancing Automation and Control
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optional-implement-it-yourself" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optional: Implement It Yourself
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Optional: Implement It Yourself">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Steps
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#experiment-further" class="md-nav__link">
    <span class="md-ellipsis">
      
        Experiment Further
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Experiment Further">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-implement-real-human-approval" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Implement Real Human Approval
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-add-approval-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Add Approval Workflows
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-track-approval-metrics" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Track Approval Metrics
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-implement-approval-timeouts" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Implement Approval Timeouts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-add-approval-history" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Add Approval History
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        Troubleshooting
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#whats-next" class="md-nav__link">
    <span class="md-ellipsis">
      
        What&rsquo;s Next?
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<div><h1 id="step-06-human-in-the-loop-pattern">Step 06 - Human-in-the-Loop Pattern<a class="headerlink" href="#step-06-human-in-the-loop-pattern" title="Permanent link"></a></h1>
<h2 id="human-in-the-loop-pattern">Human-in-the-Loop Pattern<a class="headerlink" href="#human-in-the-loop-pattern" title="Permanent link"></a></h2>
<p>In the previous step, you built a <strong>distributed agent system</strong> using Agent-to-Agent (A2A) communication, where the DispositionAgent ran as a remote service.</p>
<p>However, that system made autonomous decisions about vehicle disposition without human oversight. What if you need <strong>human approval</strong> before executing high-stakes decisions, especially for valuable assets?</p>
<p>In this step, you’ll learn about the <strong>Human-in-the-Loop (HITL) pattern</strong> - a critical approach where AI agents pause execution to request human approval before proceeding with significant actions.</p>
<hr>
<h2 id="new-requirement-from-miles-of-smiles-management-human-approval-for-high-value-dispositions">New Requirement from Miles of Smiles Management: Human Approval for High-Value Dispositions<a class="headerlink" href="#new-requirement-from-miles-of-smiles-management-human-approval-for-high-value-dispositions" title="Permanent link"></a></h2>
<p>The Miles of Smiles management team has identified a risk: the system is making autonomous disposition decisions on high-value vehicles without human oversight.</p>
<p>They want to implement a <strong>human approval gate</strong> with these requirements:</p>
<ol>
<li><strong>Value threshold</strong>: Any vehicle worth more than <strong>$15,000</strong> requires human approval before disposition</li>
<li><strong>Two-phase workflow</strong>:<ul>
<li>Phase 1: AI creates a disposition <strong>proposal</strong></li>
<li>Phase 2: Human reviews and <strong>approves or rejects</strong> the proposal</li>
</ul>
</li>
<li><strong>Execution control</strong>: Only execute approved dispositions</li>
<li><strong>Audit trail</strong>: Track approval status and reasoning for compliance</li>
</ol>
<p>This ensures that expensive vehicles aren’t scrapped or sold without proper human review.</p>
<hr>
<h2 id="what-youll-learn">What You’ll Learn<a class="headerlink" href="#what-youll-learn" title="Permanent link"></a></h2>
<p>In this step, you will:</p>
<ul>
<li>Understand the <strong>Human-in-the-Loop (HITL) pattern</strong> and when to use it</li>
<li>Implement a <strong>two-phase approval workflow</strong> (proposal → review → execution)</li>
<li>Create a <strong>DispositionProposalAgent</strong> that generates proposals</li>
<li>Build a <strong>HumanApprovalAgent</strong> that simulates human decision-making</li>
<li>Modify the <strong>FleetSupervisorAgent</strong> to route high-value vehicles through approval</li>
<li>Add <strong>approval tracking</strong> to the data model</li>
<li>See how HITL provides <strong>safety and control</strong> in autonomous systems</li>
</ul>
<hr>
<h2 id="understanding-human-in-the-loop">Understanding Human-in-the-Loop<a class="headerlink" href="#understanding-human-in-the-loop" title="Permanent link"></a></h2>
<h3 id="what-is-human-in-the-loop">What is Human-in-the-Loop?<a class="headerlink" href="#what-is-human-in-the-loop" title="Permanent link"></a></h3>
<p><strong>Human-in-the-Loop (HITL)</strong> is a pattern where:</p>
<ul>
<li>AI agents perform analysis and create recommendations</li>
<li>Execution <strong>pauses</strong> to request human approval</li>
<li>Humans review proposals and make final decisions</li>
<li>System proceeds only after approval</li>
</ul>
<h3 id="hitl-vs-fully-autonomous">HITL vs. Fully Autonomous<a class="headerlink" href="#hitl-vs-fully-autonomous" title="Permanent link"></a></h3>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Fully Autonomous</th>
<th>Human-in-the-Loop</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Speed</strong></td>
<td>Fast, immediate</td>
<td>Slower, waits for human</td>
</tr>
<tr>
<td><strong>Scalability</strong></td>
<td>Unlimited</td>
<td>Limited by human capacity</td>
</tr>
<tr>
<td><strong>Accuracy</strong></td>
<td>Consistent but may miss edge cases</td>
<td>Human judgment for complex cases</td>
</tr>
<tr>
<td><strong>Accountability</strong></td>
<td>System responsibility</td>
<td>Human responsibility</td>
</tr>
<tr>
<td><strong>Cost</strong></td>
<td>Lower operational cost</td>
<td>Higher due to human involvement</td>
</tr>
</tbody>
</table>
<h3 id="the-two-phase-workflow">The Two-Phase Workflow<a class="headerlink" href="#the-two-phase-workflow" title="Permanent link"></a></h3>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>sequenceDiagram
    participant System as Agentic System
    participant Proposal as Proposal Agent
    participant Human as Human Reviewer
    participant Execution as Execution Agent

    System-&gt;&gt;Proposal: Analyze situation
    Proposal-&gt;&gt;Proposal: Create recommendation
    Proposal--&gt;&gt;System: Proposal ready

    System-&gt;&gt;Human: Request approval
    Note over Human: Human reviews&lt;br/&gt;proposal details
    Human--&gt;&gt;System: APPROVED/REJECTED

    alt Approved
        System-&gt;&gt;Execution: Execute proposal
        Execution--&gt;&gt;System: Action completed
    else Rejected
        System-&gt;&gt;System: Fallback action
        Note over System: Route to alternative&lt;br/&gt;processing path
    end</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<hr>
<h2 id="what-is-being-added">What is Being Added?<a class="headerlink" href="#what-is-being-added" title="Permanent link"></a></h2>
<p>We’re enhancing our car management system with:</p>
<ul>
<li><strong>DispositionProposalAgent</strong>: Creates disposition proposals for review</li>
<li><strong>HumanApprovalAgent</strong>: Simulates human approval decisions (in production, this would integrate with a real approval system)</li>
<li><strong>Updated FleetSupervisorAgent</strong>: Routes high-value vehicles through the approval workflow</li>
<li><strong>Enhanced CarConditions</strong>: Tracks approval status and reasoning</li>
<li><strong>Value-based routing</strong>: Different paths for high-value vs. low-value vehicles</li>
</ul>
<h3 id="the-complete-hitl-architecture">The Complete HITL Architecture<a class="headerlink" href="#the-complete-hitl-architecture" title="Permanent link"></a></h3>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>graph TB
    Start([Car Return]) --&gt; A[CarProcessingWorkflow&lt;br/&gt;Sequential]

    A --&gt; B[Step 1: FeedbackWorkflow&lt;br/&gt;Parallel Analysis]
    B --&gt; B1[CleaningFeedbackAgent]
    B --&gt; B2[MaintenanceFeedbackAgent]
    B --&gt; B3[DispositionFeedbackAgent]
    B1 --&gt; BEnd[All feedback complete]
    B2 --&gt; BEnd
    B3 --&gt; BEnd

    BEnd --&gt; C[Step 2: FleetSupervisorAgent&lt;br/&gt;Autonomous Orchestration]
    C --&gt; C1{Disposition&lt;br/&gt;Required?}

    C1 --&gt;|Yes| PA[PricingAgent&lt;br/&gt;Estimate Value]
    PA --&gt; VCheck{Value &gt; $15k?}

    VCheck --&gt;|Yes - HIGH VALUE| Proposal[DispositionProposalAgent&lt;br/&gt;Create Proposal]
    Proposal --&gt; Approval[HumanApprovalAgent&lt;br/&gt;Review &amp; Decide]
    Approval --&gt; ApprovalCheck{Approved?}
    ApprovalCheck --&gt;|Yes| Execute[Execute Disposition]
    ApprovalCheck --&gt;|No| Fallback[Route to Maintenance/Cleaning]

    VCheck --&gt;|No - LOW VALUE| Direct[DispositionAgent&lt;br/&gt;Direct Decision]
    Direct --&gt; Execute

    C1 --&gt;|No| Other[MaintenanceAgent or CleaningAgent]

    Execute --&gt; CEnd[Supervisor Decision]
    Fallback --&gt; CEnd
    Other --&gt; CEnd

    CEnd --&gt; D[Step 3: CarConditionFeedbackAgent&lt;br/&gt;Final Summary]
    D --&gt; End([Updated Car with Approval Status])

    style A fill:#90EE90
    style B fill:#87CEEB
    style C fill:#FFB6C1
    style D fill:#90EE90
    style Proposal fill:#FFD700
    style Approval fill:#FF6B6B
    style VCheck fill:#FFA07A
    style ApprovalCheck fill:#FFA07A
    style Start fill:#E8E8E8
    style End fill:#E8E8E8</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<p><strong>The Key Innovation:</strong></p>
<p>The <strong>FleetSupervisorAgent</strong> now implements value-based routing:</p>
<ul>
<li><strong>High-value path</strong> (&gt;$15,000): PricingAgent → DispositionProposalAgent → HumanApprovalAgent → Execute if approved</li>
<li><strong>Low-value path</strong> (≤$15,000): PricingAgent → DispositionAgent → Execute directly</li>
<li><strong>Fallback</strong>: If approval rejected, route to maintenance or cleaning instead</li>
</ul>
<hr>
<h2 id="implementing-the-human-in-the-loop-pattern">Implementing the Human-in-the-Loop Pattern<a class="headerlink" href="#implementing-the-human-in-the-loop-pattern" title="Permanent link"></a></h2>
<p>Let’s build the HITL system step by step.</p>
<h3 id="create-the-dispositionproposalagent">Create the DispositionProposalAgent<a class="headerlink" href="#create-the-dispositionproposalagent" title="Permanent link"></a></h3>
<p>This agent creates disposition proposals that will be reviewed by humans.</p>
<p>Create <code>src/main/java/com/carmanagement/agentic/agents/DispositionProposalAgent.java</code>:</p>
<div class="highlight"><span class="filename">DispositionProposalAgent.java</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.agentic.agents</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.agentic.Agent</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.SystemMessage</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.UserMessage</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="cm">/**</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="cm"> * Agent that creates disposition proposals for vehicles requiring disposition.</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="cm"> * This agent analyzes the vehicle and creates a proposal that will be reviewed</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="cm"> * by the HumanApprovalAgent if the vehicle value exceeds the threshold.</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="cm"> */</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">DispositionProposalAgent</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="hll"><span class="w">    </span><span class="nd">@SystemMessage</span><span class="p">(</span><span class="s">"""</span>
</span><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="hll"><span class="s">        You are a car disposition specialist for a car rental company.</span>
</span><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="hll"><span class="s">        Your job is to create a disposition proposal based on the car's value, condition, age, and damage.</span>
</span><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="hll">
</span><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="hll"><span class="s">        Disposition Options:</span>
</span><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="hll"><span class="s">        - SCRAP: Car is beyond economical repair or has severe safety concerns</span>
</span><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="hll"><span class="s">        - SELL: Car has value but is aging out of the fleet or has moderate damage</span>
</span><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="hll"><span class="s">        - DONATE: Car has minimal value but could serve a charitable purpose</span>
</span><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="hll"><span class="s">        - KEEP: Car is worth keeping in the fleet</span>
</span><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="hll">
</span><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="hll"><span class="s">        Decision Criteria:</span>
</span><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a><span class="hll"><span class="s">        - If estimated repair cost &gt; 50% of car value: Consider SCRAP or SELL</span>
</span><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a><span class="hll"><span class="s">        - If car is over 5 years old with significant damage: SCRAP</span>
</span><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a><span class="hll"><span class="s">        - If car is 3-5 years old in fair condition: SELL</span>
</span><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a><span class="hll"><span class="s">        - If car has low value (&lt;$5,000) but functional: DONATE</span>
</span><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a><span class="hll"><span class="s">        - If car is valuable and damage is minor: KEEP</span>
</span><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a><span class="s">        Your response must include:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a><span class="s">        1. Proposed Action with unique marker: __SCRAP__ or __SELL__ or __DONATE__ or __KEEP__</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a><span class="s">        2. Reasoning: Clear explanation of your recommendation</span>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a><span class="s">        Format your response as:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a><span class="s">        Proposed Action: __[SCRAP/SELL/DONATE/KEEP]__</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#__codelineno-0-37"></a><span class="s">        Reasoning: [Your detailed explanation]</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#__codelineno-0-38"></a><span class="hll">
</span><a id="__codelineno-0-39" name="__codelineno-0-39" href="#__codelineno-0-39"></a><span class="hll"><span class="s">        CRITICAL: Use double underscores around the action (e.g., __KEEP__ not KEEP)</span>
</span><a id="__codelineno-0-40" name="__codelineno-0-40" href="#__codelineno-0-40"></a><span class="hll"><span class="s">        """</span><span class="p">)</span>
</span><a id="__codelineno-0-41" name="__codelineno-0-41" href="#__codelineno-0-41"></a><span class="hll"><span class="w">    </span><span class="nd">@UserMessage</span><span class="p">(</span><span class="s">"""</span>
</span><a id="__codelineno-0-42" name="__codelineno-0-42" href="#__codelineno-0-42"></a><span class="hll"><span class="s">        Create a disposition proposal for this vehicle:</span>
</span><a id="__codelineno-0-43" name="__codelineno-0-43" href="#__codelineno-0-43"></a><span class="hll"><span class="s">        - Make: {carMake}</span>
</span><a id="__codelineno-0-44" name="__codelineno-0-44" href="#__codelineno-0-44"></a><span class="hll"><span class="s">        - Model: {carModel}</span>
</span><a id="__codelineno-0-45" name="__codelineno-0-45" href="#__codelineno-0-45"></a><span class="hll"><span class="s">        - Year: {carYear}</span>
</span><a id="__codelineno-0-46" name="__codelineno-0-46" href="#__codelineno-0-46"></a><span class="hll"><span class="s">        - Car Number: {carNumber}</span>
</span><a id="__codelineno-0-47" name="__codelineno-0-47" href="#__codelineno-0-47"></a><span class="hll"><span class="s">        - Current Condition: {carCondition}</span>
</span><a id="__codelineno-0-48" name="__codelineno-0-48" href="#__codelineno-0-48"></a><span class="hll"><span class="s">        - Estimated Value: {carValue}</span>
</span><a id="__codelineno-0-49" name="__codelineno-0-49" href="#__codelineno-0-49"></a><span class="s">        - Damage/Feedback: {rentalFeedback}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50" href="#__codelineno-0-50"></a>
<a id="__codelineno-0-51" name="__codelineno-0-51" href="#__codelineno-0-51"></a><span class="hll"><span class="s">        Provide your disposition proposal with clear reasoning.</span>
</span><a id="__codelineno-0-52" name="__codelineno-0-52" href="#__codelineno-0-52"></a><span class="s">        """</span><span class="p">)</span>
<a id="__codelineno-0-53" name="__codelineno-0-53" href="#__codelineno-0-53"></a><span class="w">    </span><span class="nd">@Agent</span><span class="p">(</span><span class="n">outputKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"dispositionProposal"</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Creates disposition proposals for vehicles requiring disposition"</span><span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54" href="#__codelineno-0-54"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">createDispositionProposal</span><span class="p">(</span>
<a id="__codelineno-0-55" name="__codelineno-0-55" href="#__codelineno-0-55"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
<a id="__codelineno-0-56" name="__codelineno-0-56" href="#__codelineno-0-56"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57" href="#__codelineno-0-57"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58" href="#__codelineno-0-58"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59" href="#__codelineno-0-59"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60" href="#__codelineno-0-60"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61" href="#__codelineno-0-61"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">);</span>
<a id="__codelineno-0-62" name="__codelineno-0-62" href="#__codelineno-0-62"></a><span class="p">}</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Why two disposition agents?</p>
<p>You might wonder why we have both DispositionProposalAgent and DispositionAgent (from Step 5). They serve different purposes: DispositionProposalAgent creates recommendations for human review on high-value vehicles (&gt;$15K), while DispositionAgent makes autonomous decisions on lower-value vehicles. Think of it like needing manager approval for expensive purchases but having autonomy for small ones.</p>
</div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Creates <strong>proposals</strong> rather than final decisions</li>
<li>Uses same decision criteria as DispositionAgent</li>
<li>Output format includes “Proposed Action” and “Reasoning”</li>
<li>Stored in AgenticScope with key <code>dispositionProposal</code></li>
</ul>
<h3 id="create-the-humanapprovalagent">Create the HumanApprovalAgent<a class="headerlink" href="#create-the-humanapprovalagent" title="Permanent link"></a></h3>
<p>This agent implements Human-in-the-Loop by using a tool that <strong>pauses workflow execution</strong> until a human makes a decision through the UI.</p>
<p>Create <code>src/main/java/com/carmanagement/agentic/agents/HumanApprovalAgent.java</code>:</p>
<div class="highlight"><span class="filename">HumanApprovalAgent.java</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.agentic.agents</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.agentic.tools.HumanApprovalTool</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.agentic.Agent</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.SystemMessage</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.service.UserMessage</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkiverse.langchain4j.ToolBox</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="cm">/**</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="cm"> * TRUE Human-in-the-Loop Agent that uses a tool to pause workflow execution</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="cm"> * and wait for actual human approval through the UI.</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="cm"> *</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="cm"> * This agent has access to the requestHumanApproval tool which BLOCKS execution</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="hll"><span class="cm"> * until a human makes a decision via the REST API and UI.</span>
</span><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="hll"><span class="cm"> */</span>
</span><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="hll"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">HumanApprovalAgent</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="hll">
</span><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="hll"><span class="w">    </span><span class="nd">@SystemMessage</span><span class="p">(</span><span class="s">"""</span>
</span><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="hll"><span class="s">        You are a human approval coordinator for high-value vehicle dispositions.</span>
</span><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="hll">
</span><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="hll"><span class="s">        Your role is to request human approval for disposition proposals by using the requestHumanApproval tool.</span>
</span><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="hll">
</span><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="hll"><span class="s">        IMPORTANT: You MUST call the requestHumanApproval tool with ALL the provided information.</span>
</span><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="hll"><span class="s">        The tool will pause the workflow and wait for a human to approve or reject the proposal through the UI.</span>
</span><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="hll">
</span><a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="hll"><span class="s">        After calling the tool, you will receive the human's decision. Format your response as:</span>
</span><a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="hll">
</span><a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="hll"><span class="s">        Decision: [APPROVED or REJECTED]</span>
</span><a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="hll"><span class="s">        Reason: [The human's reasoning]</span>
</span><a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="hll">
</span><a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="hll"><span class="s">        Do not make decisions yourself - always use the tool to get human input.</span>
</span><a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="hll"><span class="s">        """</span><span class="p">)</span>
</span><a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a><span class="hll"><span class="w">    </span><span class="nd">@UserMessage</span><span class="p">(</span><span class="s">"""</span>
</span><a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="hll"><span class="s">        A disposition proposal needs human approval:</span>
</span><a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="hll">
</span><a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="s">        Vehicle: {carYear} {carMake} {carModel} (#{carNumber})</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a><span class="s">        Estimated Value: {carValue}</span>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="hll"><span class="s">        Current Condition: {carCondition}</span>
</span><a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="hll"><span class="s">        Damage Report: {rentalFeedback}</span>
</span><a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="hll">
</span><a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="hll"><span class="s">        Proposed Action: {proposedDisposition}</span>
</span><a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="hll"><span class="s">        Reasoning: {dispositionReason}</span>
</span><a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="hll">
</span><a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="hll"><span class="s">        Use the requestHumanApproval tool to get human approval for this proposal.</span>
</span><a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a><span class="hll"><span class="s">        Pass ALL the information to the tool.</span>
</span><a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="hll"><span class="s">        """</span><span class="p">)</span>
</span><a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="hll"><span class="w">    </span><span class="nd">@Agent</span><span class="p">(</span><span class="n">outputKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"approvalDecision"</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"Coordinates human approval for high-value vehicle dispositions using the requestHumanApproval tool"</span><span class="p">)</span>
</span><a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="hll"><span class="w">    </span><span class="nd">@ToolBox</span><span class="p">(</span><span class="n">HumanApprovalTool</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="hll"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">reviewDispositionProposal</span><span class="p">(</span>
</span><a id="__codelineno-1-50" name="__codelineno-1-50" href="#__codelineno-1-50"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
</span><a id="__codelineno-1-51" name="__codelineno-1-51" href="#__codelineno-1-51"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
</span><a id="__codelineno-1-52" name="__codelineno-1-52" href="#__codelineno-1-52"></a><span class="hll"><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
</span><a id="__codelineno-1-53" name="__codelineno-1-53" href="#__codelineno-1-53"></a><span class="hll"><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
</span><a id="__codelineno-1-54" name="__codelineno-1-54" href="#__codelineno-1-54"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
</span><a id="__codelineno-1-55" name="__codelineno-1-55" href="#__codelineno-1-55"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">,</span>
</span><a id="__codelineno-1-56" name="__codelineno-1-56" href="#__codelineno-1-56"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span>
</span><a id="__codelineno-1-57" name="__codelineno-1-57" href="#__codelineno-1-57"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
</span><a id="__codelineno-1-58" name="__codelineno-1-58" href="#__codelineno-1-58"></a><span class="hll"><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">);</span>
</span><a id="__codelineno-1-59" name="__codelineno-1-59" href="#__codelineno-1-59"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Uses the <code>requestHumanApproval</code> tool which <strong>blocks execution</strong> until human decides</li>
<li>The tool calls <code>HumanInputService.requestInput()</code> which returns a <code>CompletableFuture</code></li>
<li>Workflow execution pauses by calling <code>.get()</code> on the future</li>
<li>Human sees pending approval in the UI and clicks Approve/Reject</li>
<li>The future completes, workflow resumes with the human’s decision</li>
<li>Returns structured decision: APPROVED/REJECTED with reasoning</li>
<li>Stored in AgenticScope with key <code>approvalDecision</code></li>
</ul>
<p>!!!note @HumanInTheLoop annotation
    LangChain4j also has a @HumanInTheLoop annotation that can be used to mark methods that require human approval. This is a simpler approach than using a tool, but as of now doesn’t provide the same level of control over the approval process.</p>
<h3 id="create-the-humanapprovaltool">Create the HumanApprovalTool<a class="headerlink" href="#create-the-humanapprovaltool" title="Permanent link"></a></h3>
<p>This tool implements the actual blocking mechanism for TRUE HITL.</p>
<p>Create <code>src/main/java/com/carmanagement/agentic/tools/HumanApprovalTool.java</code>:</p>
<div class="highlight"><span class="filename">HumanApprovalTool.java</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.agentic.tools</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.model.ApprovalProposal</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.service.ApprovalService</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.agent.tool.Tool</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.logging.Log</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeUnit</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.TimeoutException</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="cm">/**</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="cm"> * Tool that enables TRUE Human-in-the-Loop by blocking workflow execution</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="cm"> * until a human makes an approval decision through the UI.</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a><span class="cm"> */</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HumanApprovalTool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a><span class="w">    </span><span class="n">ApprovalService</span><span class="w"> </span><span class="n">approvalService</span><span class="p">;</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">    </span><span class="nd">@Tool</span><span class="p">(</span><span class="s">"Request human approval for a high-value vehicle disposition proposal. This will PAUSE the workflow until a human approves or rejects the proposal via the UI."</span><span class="p">)</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">requestHumanApproval</span><span class="p">(</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
<a id="__codelineno-2-29" name="__codelineno-2-29" href="#__codelineno-2-29"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
<a id="__codelineno-2-30" name="__codelineno-2-30" href="#__codelineno-2-30"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-2-31" name="__codelineno-2-31" href="#__codelineno-2-31"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">,</span>
<a id="__codelineno-2-32" name="__codelineno-2-32" href="#__codelineno-2-32"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span>
<a id="__codelineno-2-33" name="__codelineno-2-33" href="#__codelineno-2-33"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
<a id="__codelineno-2-34" name="__codelineno-2-34" href="#__codelineno-2-34"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-35" name="__codelineno-2-35" href="#__codelineno-2-35"></a>
<a id="__codelineno-2-36" name="__codelineno-2-36" href="#__codelineno-2-36"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"🛑 HITL Tool: Creating approval proposal for car %d - %s %s %s"</span><span class="p">,</span><span class="w"> </span>
<a id="__codelineno-2-37" name="__codelineno-2-37" href="#__codelineno-2-37"></a><span class="w">                </span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span><span class="w"> </span><span class="n">carModel</span><span class="p">);</span>
<a id="__codelineno-2-38" name="__codelineno-2-38" href="#__codelineno-2-38"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"⏸️  WORKFLOW PAUSED - Waiting for human approval decision via UI"</span><span class="p">);</span>
<a id="__codelineno-2-39" name="__codelineno-2-39" href="#__codelineno-2-39"></a>
<a id="__codelineno-2-40" name="__codelineno-2-40" href="#__codelineno-2-40"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-41" name="__codelineno-2-41" href="#__codelineno-2-41"></a><span class="w">            </span><span class="c1">// Create proposal and get CompletableFuture that completes when human decides</span>
<a id="__codelineno-2-42" name="__codelineno-2-42" href="#__codelineno-2-42"></a><span class="w">            </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">approvalFuture</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-2-43" name="__codelineno-2-43" href="#__codelineno-2-43"></a><span class="w">                </span><span class="n">approvalService</span><span class="p">.</span><span class="na">createProposalAndWaitForDecision</span><span class="p">(</span>
<a id="__codelineno-2-44" name="__codelineno-2-44" href="#__codelineno-2-44"></a><span class="w">                    </span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-2-45" name="__codelineno-2-45" href="#__codelineno-2-45"></a><span class="w">                    </span><span class="n">proposedDisposition</span><span class="p">,</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span><span class="w"> </span><span class="n">rentalFeedback</span>
<a id="__codelineno-2-46" name="__codelineno-2-46" href="#__codelineno-2-46"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-2-47" name="__codelineno-2-47" href="#__codelineno-2-47"></a>
<a id="__codelineno-2-48" name="__codelineno-2-48" href="#__codelineno-2-48"></a><span class="w">            </span><span class="c1">// BLOCK HERE until human makes decision (with 5 minute timeout)</span>
<a id="__codelineno-2-49" name="__codelineno-2-49" href="#__codelineno-2-49"></a><span class="w">            </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalFuture</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">);</span>
<a id="__codelineno-2-50" name="__codelineno-2-50" href="#__codelineno-2-50"></a>
<a id="__codelineno-2-51" name="__codelineno-2-51" href="#__codelineno-2-51"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"▶️  WORKFLOW RESUMED - Human decision received: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">decision</span><span class="p">);</span>
<a id="__codelineno-2-52" name="__codelineno-2-52" href="#__codelineno-2-52"></a>
<a id="__codelineno-2-53" name="__codelineno-2-53" href="#__codelineno-2-53"></a><span class="w">            </span><span class="c1">// Format response for the agent</span>
<a id="__codelineno-2-54" name="__codelineno-2-54" href="#__codelineno-2-54"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"""</span>
<a id="__codelineno-2-55" name="__codelineno-2-55" href="#__codelineno-2-55"></a><span class="s">                Human Decision: %s</span>
<a id="__codelineno-2-56" name="__codelineno-2-56" href="#__codelineno-2-56"></a><span class="s">                Reason: %s</span>
<a id="__codelineno-2-57" name="__codelineno-2-57" href="#__codelineno-2-57"></a><span class="s">                Approved By: %s</span>
<a id="__codelineno-2-58" name="__codelineno-2-58" href="#__codelineno-2-58"></a><span class="s">                Decision Time: %s</span>
<a id="__codelineno-2-59" name="__codelineno-2-59" href="#__codelineno-2-59"></a><span class="s">                """</span><span class="p">,</span>
<a id="__codelineno-2-60" name="__codelineno-2-60" href="#__codelineno-2-60"></a><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">decision</span><span class="p">,</span>
<a id="__codelineno-2-61" name="__codelineno-2-61" href="#__codelineno-2-61"></a><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">approvalReason</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">approvalReason</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">"No reason provided"</span><span class="p">,</span>
<a id="__codelineno-2-62" name="__codelineno-2-62" href="#__codelineno-2-62"></a><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">approvedBy</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">approvedBy</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">"Unknown"</span><span class="p">,</span>
<a id="__codelineno-2-63" name="__codelineno-2-63" href="#__codelineno-2-63"></a><span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="na">decidedAt</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">decidedAt</span><span class="p">.</span><span class="na">toString</span><span class="p">()</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">"Unknown"</span>
<a id="__codelineno-2-64" name="__codelineno-2-64" href="#__codelineno-2-64"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-2-65" name="__codelineno-2-65" href="#__codelineno-2-65"></a>
<a id="__codelineno-2-66" name="__codelineno-2-66" href="#__codelineno-2-66"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">TimeoutException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-67" name="__codelineno-2-67" href="#__codelineno-2-67"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"⏱️  TIMEOUT: No human decision received within 5 minutes, defaulting to REJECTED"</span><span class="p">);</span>
<a id="__codelineno-2-68" name="__codelineno-2-68" href="#__codelineno-2-68"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-2-69" name="__codelineno-2-69" href="#__codelineno-2-69"></a><span class="s">                Human Decision: REJECTED</span>
<a id="__codelineno-2-70" name="__codelineno-2-70" href="#__codelineno-2-70"></a><span class="s">                Reason: Timeout - No human decision received within 5 minutes. Defaulting to rejection for safety.</span>
<a id="__codelineno-2-71" name="__codelineno-2-71" href="#__codelineno-2-71"></a><span class="s">                Approved By: System (Timeout)</span>
<a id="__codelineno-2-72" name="__codelineno-2-72" href="#__codelineno-2-72"></a><span class="s">                """</span><span class="p">;</span>
<a id="__codelineno-2-73" name="__codelineno-2-73" href="#__codelineno-2-73"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-74" name="__codelineno-2-74" href="#__codelineno-2-74"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">errorf</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="s">"❌ ERROR: Failed to get human approval for car %d"</span><span class="p">,</span><span class="w"> </span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-2-75" name="__codelineno-2-75" href="#__codelineno-2-75"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">"""</span>
<a id="__codelineno-2-76" name="__codelineno-2-76" href="#__codelineno-2-76"></a><span class="s">                Human Decision: REJECTED</span>
<a id="__codelineno-2-77" name="__codelineno-2-77" href="#__codelineno-2-77"></a><span class="s">                Reason: Error occurred while waiting for human approval: %s</span>
<a id="__codelineno-2-78" name="__codelineno-2-78" href="#__codelineno-2-78"></a><span class="s">                Approved By: System (Error)</span>
<a id="__codelineno-2-79" name="__codelineno-2-79" href="#__codelineno-2-79"></a><span class="s">                """</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
<a id="__codelineno-2-80" name="__codelineno-2-80" href="#__codelineno-2-80"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-81" name="__codelineno-2-81" href="#__codelineno-2-81"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-82" name="__codelineno-2-82" href="#__codelineno-2-82"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Creates an approval proposal in the database</li>
<li>Returns a <code>CompletableFuture&lt;ApprovalProposal&gt;</code> that completes when human decides</li>
<li><strong>Blocks by calling <code>.get(5, TimeUnit.MINUTES)</code></strong> - this is where the workflow pauses!</li>
<li>Workflow thread waits here until human clicks Approve/Reject in UI</li>
<li>Includes 5-minute timeout for safety</li>
<li>Returns human’s decision to the agent</li>
</ul>
<h3 id="create-the-approvalservice">Create the ApprovalService<a class="headerlink" href="#create-the-approvalservice" title="Permanent link"></a></h3>
<p>This service manages the CompletableFutures that pause workflow execution.</p>
<p>Create <code>src/main/java/com/carmanagement/service/ApprovalService.java</code>:</p>
<div class="highlight"><span class="filename">ApprovalService.java</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.service</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.model.ApprovalProposal</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.model.ApprovalProposal.ApprovalStatus</span><span class="p">;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.logging.Log</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.vertx.ConsumeEvent</span><span class="p">;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.EntityManager</span><span class="p">;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.transaction.Transactional</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">jakarta.transaction.Transactional.TxType</span><span class="p">;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ConcurrentHashMap</span><span class="p">;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.ExecutorService</span><span class="p">;</span>
<a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Executors</span><span class="p">;</span>
<a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a>
<a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="cm">/**</span>
<a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a><span class="cm"> * Service for managing approval proposals and the Human-in-the-Loop workflow.</span>
<a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="cm"> * This service handles the async nature of human approvals - creating proposals,</span>
<a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a><span class="cm"> * waiting for human decisions, and continuing workflow execution.</span>
<a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="cm"> */</span>
<a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApprovalService</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a>
<a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">    </span><span class="n">EntityManager</span><span class="w"> </span><span class="n">entityManager</span><span class="p">;</span>
<a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
<a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="cm">     * Map to store CompletableFutures waiting for approval decisions.</span>
<a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="cm">     * Key: carNumber, Value: CompletableFuture that completes when decision is made</span>
<a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="cm">     */</span>
<a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">pendingApprovals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a>
<a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="cm">     * Executor for async proposal creation to ensure transaction commits before blocking</span>
<a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a><span class="cm">     */</span>
<a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ExecutorService</span><span class="w"> </span><span class="n">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Executors</span><span class="p">.</span><span class="na">newCachedThreadPool</span><span class="p">();</span>
<a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a>
<a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a><span class="cm">     * Create a new approval proposal and return a CompletableFuture that will complete</span>
<a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="cm">     * when a human makes a decision.</span>
<a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="cm">     * </span>
<a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="cm">     * @param carNumber The car number</span>
<a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a><span class="cm">     * @param carMake Car make</span>
<a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="cm">     * @param carModel Car model</span>
<a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="cm">     * @param carYear Car year</span>
<a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="cm">     * @param carValue Estimated car value</span>
<a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="cm">     * @param proposedDisposition Proposed action (SCRAP, SELL, DONATE, KEEP)</span>
<a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="cm">     * @param dispositionReason Reasoning for the proposal</span>
<a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="cm">     * @param carCondition Current car condition</span>
<a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="cm">     * @param rentalFeedback Rental feedback</span>
<a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a><span class="cm">     * @return CompletableFuture that completes when human approves/rejects</span>
<a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a><span class="cm">     */</span>
<a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createProposalAndWaitForDecision</span><span class="p">(</span>
<a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
<a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
<a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
<a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
<a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">,</span>
<a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span>
<a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
<a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a>
<a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a><span class="w">        </span><span class="c1">// Check if there's already a pending proposal for this car</span>
<a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a><span class="w">        </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">existing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">.</span><span class="na">findPendingByCarNumber</span><span class="p">(</span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">existing</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">warnf</span><span class="p">(</span><span class="s">"Proposal already exists for car %d, returning existing future"</span><span class="p">,</span><span class="w"> </span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">pendingApprovals</span><span class="p">.</span><span class="na">computeIfAbsent</span><span class="p">(</span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;&gt;</span><span class="p">());</span>
<a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a>
<a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a><span class="w">        </span><span class="c1">// Create CompletableFuture first</span>
<a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a><span class="w">        </span><span class="n">pendingApprovals</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">future</span><span class="p">);</span>
<a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a>
<a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a><span class="w">        </span><span class="c1">// Create proposal in separate thread with its own transaction</span>
<a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a><span class="w">        </span><span class="c1">// This ensures the transaction commits BEFORE we return the future</span>
<a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a><span class="w">        </span><span class="n">executor</span><span class="p">.</span><span class="na">submit</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a><span class="w">            </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a><span class="w">                </span><span class="n">createProposalInNewTransaction</span><span class="p">(</span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a><span class="w">                        </span><span class="n">proposedDisposition</span><span class="p">,</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">);</span>
<a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a><span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"✅ Proposal creation transaction committed - now visible to queries"</span><span class="p">);</span>
<a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a><span class="w">                </span><span class="n">Log</span><span class="p">.</span><span class="na">errorf</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="s">"Failed to create proposal for car %d"</span><span class="p">,</span><span class="w"> </span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a><span class="w">                </span><span class="n">future</span><span class="p">.</span><span class="na">completeExceptionally</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a><span class="w">                </span><span class="n">pendingApprovals</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a>
<a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">future</span><span class="p">;</span>
<a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a>
<a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a><span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">TxType</span><span class="p">.</span><span class="na">REQUIRES_NEW</span><span class="p">)</span>
<a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">createProposalInNewTransaction</span><span class="p">(</span>
<a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
<a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
<a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
<a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a><span class="w">            </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
<a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span>
<a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">,</span>
<a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">,</span>
<a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
<a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>
<a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a><span class="w">        </span><span class="c1">// Create new proposal</span>
<a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a><span class="w">        </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">();</span>
<a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carNumber</span><span class="p">;</span>
<a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carMake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carMake</span><span class="p">;</span>
<a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carModel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carModel</span><span class="p">;</span>
<a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carYear</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carYear</span><span class="p">;</span>
<a id="__codelineno-3-116" name="__codelineno-3-116" href="#__codelineno-3-116"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carValue</span><span class="p">;</span>
<a id="__codelineno-3-117" name="__codelineno-3-117" href="#__codelineno-3-117"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">proposedDisposition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">;</span>
<a id="__codelineno-3-118" name="__codelineno-3-118" href="#__codelineno-3-118"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">dispositionReason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">;</span>
<a id="__codelineno-3-119" name="__codelineno-3-119" href="#__codelineno-3-119"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">carCondition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carCondition</span><span class="p">;</span>
<a id="__codelineno-3-120" name="__codelineno-3-120" href="#__codelineno-3-120"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">rentalFeedback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">;</span>
<a id="__codelineno-3-121" name="__codelineno-3-121" href="#__codelineno-3-121"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">;</span>
<a id="__codelineno-3-122" name="__codelineno-3-122" href="#__codelineno-3-122"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<a id="__codelineno-3-123" name="__codelineno-3-123" href="#__codelineno-3-123"></a>
<a id="__codelineno-3-124" name="__codelineno-3-124" href="#__codelineno-3-124"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">persist</span><span class="p">();</span>
<a id="__codelineno-3-125" name="__codelineno-3-125" href="#__codelineno-3-125"></a><span class="w">        </span><span class="n">entityManager</span><span class="p">.</span><span class="na">flush</span><span class="p">();</span>
<a id="__codelineno-3-126" name="__codelineno-3-126" href="#__codelineno-3-126"></a>
<a id="__codelineno-3-127" name="__codelineno-3-127" href="#__codelineno-3-127"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Created approval proposal ID=%d for car %d - %s %s %s (Value: %s, Proposed: %s)"</span><span class="p">,</span>
<a id="__codelineno-3-128" name="__codelineno-3-128" href="#__codelineno-3-128"></a><span class="w">                </span><span class="n">proposal</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span><span class="w"> </span><span class="n">carValue</span><span class="p">,</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">);</span>
<a id="__codelineno-3-129" name="__codelineno-3-129" href="#__codelineno-3-129"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"⏸️  WORKFLOW PAUSED - Waiting for human approval decision"</span><span class="p">);</span>
<a id="__codelineno-3-130" name="__codelineno-3-130" href="#__codelineno-3-130"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Proposal persisted with ID: %d, status: %s"</span><span class="p">,</span><span class="w"> </span><span class="n">proposal</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">proposal</span><span class="p">.</span><span class="na">status</span><span class="p">);</span>
<a id="__codelineno-3-131" name="__codelineno-3-131" href="#__codelineno-3-131"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-132" name="__codelineno-3-132" href="#__codelineno-3-132"></a>
<a id="__codelineno-3-133" name="__codelineno-3-133" href="#__codelineno-3-133"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-134" name="__codelineno-3-134" href="#__codelineno-3-134"></a><span class="cm">     * Process a human's approval decision and complete the waiting CompletableFuture.</span>
<a id="__codelineno-3-135" name="__codelineno-3-135" href="#__codelineno-3-135"></a><span class="cm">     * This resumes the workflow execution.</span>
<a id="__codelineno-3-136" name="__codelineno-3-136" href="#__codelineno-3-136"></a><span class="cm">     * </span>
<a id="__codelineno-3-137" name="__codelineno-3-137" href="#__codelineno-3-137"></a><span class="cm">     * @param proposalId The proposal ID</span>
<a id="__codelineno-3-138" name="__codelineno-3-138" href="#__codelineno-3-138"></a><span class="cm">     * @param approved Whether approved or rejected</span>
<a id="__codelineno-3-139" name="__codelineno-3-139" href="#__codelineno-3-139"></a><span class="cm">     * @param reason Human's reasoning</span>
<a id="__codelineno-3-140" name="__codelineno-3-140" href="#__codelineno-3-140"></a><span class="cm">     * @param approvedBy Who made the decision</span>
<a id="__codelineno-3-141" name="__codelineno-3-141" href="#__codelineno-3-141"></a><span class="cm">     * @return The updated proposal</span>
<a id="__codelineno-3-142" name="__codelineno-3-142" href="#__codelineno-3-142"></a><span class="cm">     */</span>
<a id="__codelineno-3-143" name="__codelineno-3-143" href="#__codelineno-3-143"></a><span class="w">    </span><span class="nd">@Transactional</span><span class="p">(</span><span class="n">TxType</span><span class="p">.</span><span class="na">REQUIRES_NEW</span><span class="p">)</span>
<a id="__codelineno-3-144" name="__codelineno-3-144" href="#__codelineno-3-144"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="nf">processDecision</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">approved</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-145" name="__codelineno-3-145" href="#__codelineno-3-145"></a><span class="w">        </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">proposalId</span><span class="p">);</span>
<a id="__codelineno-3-146" name="__codelineno-3-146" href="#__codelineno-3-146"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proposal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-147" name="__codelineno-3-147" href="#__codelineno-3-147"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">"Proposal not found: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proposalId</span><span class="p">);</span>
<a id="__codelineno-3-148" name="__codelineno-3-148" href="#__codelineno-3-148"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-149" name="__codelineno-3-149" href="#__codelineno-3-149"></a>
<a id="__codelineno-3-150" name="__codelineno-3-150" href="#__codelineno-3-150"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proposal</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-151" name="__codelineno-3-151" href="#__codelineno-3-151"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">"Proposal is not pending: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">proposalId</span><span class="p">);</span>
<a id="__codelineno-3-152" name="__codelineno-3-152" href="#__codelineno-3-152"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-153" name="__codelineno-3-153" href="#__codelineno-3-153"></a>
<a id="__codelineno-3-154" name="__codelineno-3-154" href="#__codelineno-3-154"></a><span class="w">        </span><span class="c1">// Update proposal with decision</span>
<a id="__codelineno-3-155" name="__codelineno-3-155" href="#__codelineno-3-155"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approved</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">APPROVED</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">REJECTED</span><span class="p">;</span>
<a id="__codelineno-3-156" name="__codelineno-3-156" href="#__codelineno-3-156"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">decision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approved</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">"APPROVED"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">"REJECTED"</span><span class="p">;</span>
<a id="__codelineno-3-157" name="__codelineno-3-157" href="#__codelineno-3-157"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">approvalReason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<a id="__codelineno-3-158" name="__codelineno-3-158" href="#__codelineno-3-158"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">approvedBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">;</span>
<a id="__codelineno-3-159" name="__codelineno-3-159" href="#__codelineno-3-159"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">decidedAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<a id="__codelineno-3-160" name="__codelineno-3-160" href="#__codelineno-3-160"></a>
<a id="__codelineno-3-161" name="__codelineno-3-161" href="#__codelineno-3-161"></a><span class="w">        </span><span class="n">proposal</span><span class="p">.</span><span class="na">persist</span><span class="p">();</span>
<a id="__codelineno-3-162" name="__codelineno-3-162" href="#__codelineno-3-162"></a>
<a id="__codelineno-3-163" name="__codelineno-3-163" href="#__codelineno-3-163"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Human decision received for car %d: %s - %s"</span><span class="p">,</span>
<a id="__codelineno-3-164" name="__codelineno-3-164" href="#__codelineno-3-164"></a><span class="w">                </span><span class="n">proposal</span><span class="p">.</span><span class="na">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">proposal</span><span class="p">.</span><span class="na">decision</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">);</span>
<a id="__codelineno-3-165" name="__codelineno-3-165" href="#__codelineno-3-165"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">"▶️  WORKFLOW RESUMED - Continuing with approval decision"</span><span class="p">);</span>
<a id="__codelineno-3-166" name="__codelineno-3-166" href="#__codelineno-3-166"></a>
<a id="__codelineno-3-167" name="__codelineno-3-167" href="#__codelineno-3-167"></a><span class="w">        </span><span class="c1">// Complete the CompletableFuture to resume workflow</span>
<a id="__codelineno-3-168" name="__codelineno-3-168" href="#__codelineno-3-168"></a><span class="w">        </span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pendingApprovals</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">proposal</span><span class="p">.</span><span class="na">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-169" name="__codelineno-3-169" href="#__codelineno-3-169"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">future</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-170" name="__codelineno-3-170" href="#__codelineno-3-170"></a><span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="na">complete</span><span class="p">(</span><span class="n">proposal</span><span class="p">);</span>
<a id="__codelineno-3-171" name="__codelineno-3-171" href="#__codelineno-3-171"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-172" name="__codelineno-3-172" href="#__codelineno-3-172"></a>
<a id="__codelineno-3-173" name="__codelineno-3-173" href="#__codelineno-3-173"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">proposal</span><span class="p">;</span>
<a id="__codelineno-3-174" name="__codelineno-3-174" href="#__codelineno-3-174"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-175" name="__codelineno-3-175" href="#__codelineno-3-175"></a>
<a id="__codelineno-3-176" name="__codelineno-3-176" href="#__codelineno-3-176"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-177" name="__codelineno-3-177" href="#__codelineno-3-177"></a><span class="cm">     * Get all pending approval proposals.</span>
<a id="__codelineno-3-178" name="__codelineno-3-178" href="#__codelineno-3-178"></a><span class="cm">     */</span>
<a id="__codelineno-3-179" name="__codelineno-3-179" href="#__codelineno-3-179"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPendingProposals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-180" name="__codelineno-3-180" href="#__codelineno-3-180"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">.</span><span class="na">findAllPending</span><span class="p">();</span>
<a id="__codelineno-3-181" name="__codelineno-3-181" href="#__codelineno-3-181"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-182" name="__codelineno-3-182" href="#__codelineno-3-182"></a>
<a id="__codelineno-3-183" name="__codelineno-3-183" href="#__codelineno-3-183"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-184" name="__codelineno-3-184" href="#__codelineno-3-184"></a><span class="cm">     * Get a specific proposal by ID.</span>
<a id="__codelineno-3-185" name="__codelineno-3-185" href="#__codelineno-3-185"></a><span class="cm">     */</span>
<a id="__codelineno-3-186" name="__codelineno-3-186" href="#__codelineno-3-186"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="nf">getProposal</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-187" name="__codelineno-3-187" href="#__codelineno-3-187"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="n">proposalId</span><span class="p">);</span>
<a id="__codelineno-3-188" name="__codelineno-3-188" href="#__codelineno-3-188"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-189" name="__codelineno-3-189" href="#__codelineno-3-189"></a>
<a id="__codelineno-3-190" name="__codelineno-3-190" href="#__codelineno-3-190"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-3-191" name="__codelineno-3-191" href="#__codelineno-3-191"></a><span class="cm">     * Check if there's a pending approval for a car.</span>
<a id="__codelineno-3-192" name="__codelineno-3-192" href="#__codelineno-3-192"></a><span class="cm">     */</span>
<a id="__codelineno-3-193" name="__codelineno-3-193" href="#__codelineno-3-193"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="nf">getPendingProposalForCar</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-194" name="__codelineno-3-194" href="#__codelineno-3-194"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="p">.</span><span class="na">findPendingByCarNumber</span><span class="p">(</span><span class="n">carNumber</span><span class="p">);</span>
<a id="__codelineno-3-195" name="__codelineno-3-195" href="#__codelineno-3-195"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-196" name="__codelineno-3-196" href="#__codelineno-3-196"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Stores <code>CompletableFuture&lt;ApprovalProposal&gt;</code> in a map keyed by car number</li>
<li><code>createProposalAndWaitForDecision()</code> creates the future and returns it</li>
<li>Proposal is persisted in a separate transaction to ensure it’s visible to UI queries</li>
<li><code>processDecision()</code> completes the future when human makes a decision</li>
<li>This completion <strong>resumes the workflow</strong> that was blocked on <code>.get()</code></li>
</ul>
<h3 id="create-the-approvalproposal-entity">Create the ApprovalProposal Entity<a class="headerlink" href="#create-the-approvalproposal-entity" title="Permanent link"></a></h3>
<p>This entity stores proposals in the database so the UI can display them.</p>
<p>Create <code>src/main/java/com/carmanagement/model/ApprovalProposal.java</code>:</p>
<div class="highlight"><span class="filename">ApprovalProposal.java</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.model</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.hibernate.orm.panache.PanacheEntity</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Entity</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.EnumType</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Enumerated</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.persistence.Column</span><span class="p">;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.LocalDateTime</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="cm">/**</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="cm"> * Entity representing a disposition proposal awaiting human approval.</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="cm"> * This is the core of the Human-in-the-Loop pattern - proposals are stored</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="cm"> * and the workflow pauses until a human makes an approval decision.</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="cm"> */</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="nd">@Entity</span>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApprovalProposal</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">PanacheEntity</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="cm">     * The car number this proposal is for</span>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="cm">     */</span>
<a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">;</span>
<a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>
<a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="cm">     * Car make</span>
<a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="cm">     */</span>
<a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">;</span>
<a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>
<a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="cm">     * Car model</span>
<a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="cm">     */</span>
<a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">;</span>
<a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>
<a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="cm">     * Car year</span>
<a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="cm">     */</span>
<a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">;</span>
<a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>
<a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="cm">     * Estimated car value</span>
<a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="cm">     */</span>
<a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">carValue</span><span class="p">;</span>
<a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a>
<a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="cm">     * Proposed disposition action (SCRAP, SELL, DONATE, KEEP)</span>
<a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="cm">     */</span>
<a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">proposedDisposition</span><span class="p">;</span>
<a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a>
<a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="cm">     * Reasoning for the proposed disposition</span>
<a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="cm">     */</span>
<a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span><span class="p">;</span>
<a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a>
<a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="cm">     * Current car condition</span>
<a id="__codelineno-4-58" name="__codelineno-4-58" href="#__codelineno-4-58"></a><span class="cm">     */</span>
<a id="__codelineno-4-59" name="__codelineno-4-59" href="#__codelineno-4-59"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-4-60" name="__codelineno-4-60" href="#__codelineno-4-60"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">;</span>
<a id="__codelineno-4-61" name="__codelineno-4-61" href="#__codelineno-4-61"></a>
<a id="__codelineno-4-62" name="__codelineno-4-62" href="#__codelineno-4-62"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-63" name="__codelineno-4-63" href="#__codelineno-4-63"></a><span class="cm">     * Rental feedback that triggered this proposal</span>
<a id="__codelineno-4-64" name="__codelineno-4-64" href="#__codelineno-4-64"></a><span class="cm">     */</span>
<a id="__codelineno-4-65" name="__codelineno-4-65" href="#__codelineno-4-65"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2000</span><span class="p">)</span>
<a id="__codelineno-4-66" name="__codelineno-4-66" href="#__codelineno-4-66"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">;</span>
<a id="__codelineno-4-67" name="__codelineno-4-67" href="#__codelineno-4-67"></a>
<a id="__codelineno-4-68" name="__codelineno-4-68" href="#__codelineno-4-68"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-69" name="__codelineno-4-69" href="#__codelineno-4-69"></a><span class="cm">     * Current status of the approval</span>
<a id="__codelineno-4-70" name="__codelineno-4-70" href="#__codelineno-4-70"></a><span class="cm">     */</span>
<a id="__codelineno-4-71" name="__codelineno-4-71" href="#__codelineno-4-71"></a><span class="w">    </span><span class="nd">@Enumerated</span><span class="p">(</span><span class="n">EnumType</span><span class="p">.</span><span class="na">STRING</span><span class="p">)</span>
<a id="__codelineno-4-72" name="__codelineno-4-72" href="#__codelineno-4-72"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-4-73" name="__codelineno-4-73" href="#__codelineno-4-73"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">;</span>
<a id="__codelineno-4-74" name="__codelineno-4-74" href="#__codelineno-4-74"></a>
<a id="__codelineno-4-75" name="__codelineno-4-75" href="#__codelineno-4-75"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-76" name="__codelineno-4-76" href="#__codelineno-4-76"></a><span class="cm">     * Human's decision (APPROVED or REJECTED)</span>
<a id="__codelineno-4-77" name="__codelineno-4-77" href="#__codelineno-4-77"></a><span class="cm">     */</span>
<a id="__codelineno-4-78" name="__codelineno-4-78" href="#__codelineno-4-78"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">decision</span><span class="p">;</span>
<a id="__codelineno-4-79" name="__codelineno-4-79" href="#__codelineno-4-79"></a>
<a id="__codelineno-4-80" name="__codelineno-4-80" href="#__codelineno-4-80"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-81" name="__codelineno-4-81" href="#__codelineno-4-81"></a><span class="cm">     * Human's reasoning for their decision</span>
<a id="__codelineno-4-82" name="__codelineno-4-82" href="#__codelineno-4-82"></a><span class="cm">     */</span>
<a id="__codelineno-4-83" name="__codelineno-4-83" href="#__codelineno-4-83"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">)</span>
<a id="__codelineno-4-84" name="__codelineno-4-84" href="#__codelineno-4-84"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approvalReason</span><span class="p">;</span>
<a id="__codelineno-4-85" name="__codelineno-4-85" href="#__codelineno-4-85"></a>
<a id="__codelineno-4-86" name="__codelineno-4-86" href="#__codelineno-4-86"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-87" name="__codelineno-4-87" href="#__codelineno-4-87"></a><span class="cm">     * Who approved/rejected (for audit trail)</span>
<a id="__codelineno-4-88" name="__codelineno-4-88" href="#__codelineno-4-88"></a><span class="cm">     */</span>
<a id="__codelineno-4-89" name="__codelineno-4-89" href="#__codelineno-4-89"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">;</span>
<a id="__codelineno-4-90" name="__codelineno-4-90" href="#__codelineno-4-90"></a>
<a id="__codelineno-4-91" name="__codelineno-4-91" href="#__codelineno-4-91"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-92" name="__codelineno-4-92" href="#__codelineno-4-92"></a><span class="cm">     * When the proposal was created</span>
<a id="__codelineno-4-93" name="__codelineno-4-93" href="#__codelineno-4-93"></a><span class="cm">     */</span>
<a id="__codelineno-4-94" name="__codelineno-4-94" href="#__codelineno-4-94"></a><span class="w">    </span><span class="nd">@Column</span><span class="p">(</span><span class="n">nullable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-4-95" name="__codelineno-4-95" href="#__codelineno-4-95"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">createdAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">();</span>
<a id="__codelineno-4-96" name="__codelineno-4-96" href="#__codelineno-4-96"></a>
<a id="__codelineno-4-97" name="__codelineno-4-97" href="#__codelineno-4-97"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-98" name="__codelineno-4-98" href="#__codelineno-4-98"></a><span class="cm">     * When the decision was made</span>
<a id="__codelineno-4-99" name="__codelineno-4-99" href="#__codelineno-4-99"></a><span class="cm">     */</span>
<a id="__codelineno-4-100" name="__codelineno-4-100" href="#__codelineno-4-100"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LocalDateTime</span><span class="w"> </span><span class="n">decidedAt</span><span class="p">;</span>
<a id="__codelineno-4-101" name="__codelineno-4-101" href="#__codelineno-4-101"></a>
<a id="__codelineno-4-102" name="__codelineno-4-102" href="#__codelineno-4-102"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-103" name="__codelineno-4-103" href="#__codelineno-4-103"></a><span class="cm">     * Find pending proposal for a specific car</span>
<a id="__codelineno-4-104" name="__codelineno-4-104" href="#__codelineno-4-104"></a><span class="cm">     */</span>
<a id="__codelineno-4-105" name="__codelineno-4-105" href="#__codelineno-4-105"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="nf">findPendingByCarNumber</span><span class="p">(</span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-106" name="__codelineno-4-106" href="#__codelineno-4-106"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="s">"carNumber = ?1 and status = ?2"</span><span class="p">,</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">).</span><span class="na">firstResult</span><span class="p">();</span>
<a id="__codelineno-4-107" name="__codelineno-4-107" href="#__codelineno-4-107"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-108" name="__codelineno-4-108" href="#__codelineno-4-108"></a>
<a id="__codelineno-4-109" name="__codelineno-4-109" href="#__codelineno-4-109"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-110" name="__codelineno-4-110" href="#__codelineno-4-110"></a><span class="cm">     * Find all pending proposals</span>
<a id="__codelineno-4-111" name="__codelineno-4-111" href="#__codelineno-4-111"></a><span class="cm">     */</span>
<a id="__codelineno-4-112" name="__codelineno-4-112" href="#__codelineno-4-112"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">java</span><span class="p">.</span><span class="na">util</span><span class="p">.</span><span class="na">List</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAllPending</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-113" name="__codelineno-4-113" href="#__codelineno-4-113"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">find</span><span class="p">(</span><span class="s">"status"</span><span class="p">,</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="p">.</span><span class="na">PENDING</span><span class="p">).</span><span class="na">list</span><span class="p">();</span>
<a id="__codelineno-4-114" name="__codelineno-4-114" href="#__codelineno-4-114"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-115" name="__codelineno-4-115" href="#__codelineno-4-115"></a>
<a id="__codelineno-4-116" name="__codelineno-4-116" href="#__codelineno-4-116"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-4-117" name="__codelineno-4-117" href="#__codelineno-4-117"></a><span class="cm">     * Approval status enum</span>
<a id="__codelineno-4-118" name="__codelineno-4-118" href="#__codelineno-4-118"></a><span class="cm">     */</span>
<a id="__codelineno-4-119" name="__codelineno-4-119" href="#__codelineno-4-119"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">enum</span><span class="w"> </span><span class="n">ApprovalStatus</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-120" name="__codelineno-4-120" href="#__codelineno-4-120"></a><span class="w">        </span><span class="n">PENDING</span><span class="p">,</span>
<a id="__codelineno-4-121" name="__codelineno-4-121" href="#__codelineno-4-121"></a><span class="w">        </span><span class="n">APPROVED</span><span class="p">,</span>
<a id="__codelineno-4-122" name="__codelineno-4-122" href="#__codelineno-4-122"></a><span class="w">        </span><span class="n">REJECTED</span>
<a id="__codelineno-4-123" name="__codelineno-4-123" href="#__codelineno-4-123"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-124" name="__codelineno-4-124" href="#__codelineno-4-124"></a><span class="p">}</span>
</code></pre></div>
<h3 id="create-the-approvalresource">Create the ApprovalResource<a class="headerlink" href="#create-the-approvalresource" title="Permanent link"></a></h3>
<p>This REST resource allows the UI to fetch pending approvals and submit decisions.</p>
<p>Create <code>src/main/java/com/carmanagement/resource/ApprovalResource.java</code>:</p>
<div class="highlight"><span class="filename">ApprovalResource.java</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.resource</span><span class="p">;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.model.ApprovalProposal</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">com.carmanagement.service.ApprovalService</span><span class="p">;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.ws.rs.*</span><span class="p">;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.ws.rs.core.MediaType</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.ws.rs.core.Response</span><span class="p">;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.quarkus.logging.Log</span><span class="p">;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="cm">/**</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="cm"> * REST resource for managing approval proposals.</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="cm"> * Provides endpoints for humans to view and approve/reject proposals.</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="cm"> */</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="nd">@Path</span><span class="p">(</span><span class="s">"/api/approvals"</span><span class="p">)</span>
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="nd">@Produces</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="nd">@Consumes</span><span class="p">(</span><span class="n">MediaType</span><span class="p">.</span><span class="na">APPLICATION_JSON</span><span class="p">)</span>
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApprovalResource</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w">    </span><span class="n">ApprovalService</span><span class="w"> </span><span class="n">approvalService</span><span class="p">;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a>
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="cm">     * Get all pending approval proposals.</span>
<a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="cm">     * This is called by the UI to display proposals awaiting human decision.</span>
<a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="cm">     */</span>
<a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w">    </span><span class="nd">@GET</span>
<a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w">    </span><span class="nd">@Path</span><span class="p">(</span><span class="s">"/pending"</span><span class="p">)</span>
<a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">ApprovalProposal</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getPendingProposals</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">approvalService</span><span class="p">.</span><span class="na">getPendingProposals</span><span class="p">();</span>
<a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a>
<a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="cm">     * Get a specific proposal by ID.</span>
<a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="cm">     */</span>
<a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="w">    </span><span class="nd">@GET</span>
<a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="w">    </span><span class="nd">@Path</span><span class="p">(</span><span class="s">"/{proposalId}"</span><span class="p">)</span>
<a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">getProposal</span><span class="p">(</span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"proposalId"</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="w">        </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalService</span><span class="p">.</span><span class="na">getProposal</span><span class="p">(</span><span class="n">proposalId</span><span class="p">);</span>
<a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">proposal</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">)</span>
<a id="__codelineno-5-45" name="__codelineno-5-45" href="#__codelineno-5-45"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="s">"Proposal not found"</span><span class="p">))</span>
<a id="__codelineno-5-46" name="__codelineno-5-46" href="#__codelineno-5-46"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-47" name="__codelineno-5-47" href="#__codelineno-5-47"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-48" name="__codelineno-5-48" href="#__codelineno-5-48"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">proposal</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-49" name="__codelineno-5-49" href="#__codelineno-5-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-50" name="__codelineno-5-50" href="#__codelineno-5-50"></a>
<a id="__codelineno-5-51" name="__codelineno-5-51" href="#__codelineno-5-51"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-5-52" name="__codelineno-5-52" href="#__codelineno-5-52"></a><span class="cm">     * Approve a proposal.</span>
<a id="__codelineno-5-53" name="__codelineno-5-53" href="#__codelineno-5-53"></a><span class="cm">     * This is called when a human clicks the "Approve" button in the UI.</span>
<a id="__codelineno-5-54" name="__codelineno-5-54" href="#__codelineno-5-54"></a><span class="cm">     * </span>
<a id="__codelineno-5-55" name="__codelineno-5-55" href="#__codelineno-5-55"></a><span class="cm">     * @param proposalId The proposal ID</span>
<a id="__codelineno-5-56" name="__codelineno-5-56" href="#__codelineno-5-56"></a><span class="cm">     * @param request Request body containing reason and approvedBy</span>
<a id="__codelineno-5-57" name="__codelineno-5-57" href="#__codelineno-5-57"></a><span class="cm">     */</span>
<a id="__codelineno-5-58" name="__codelineno-5-58" href="#__codelineno-5-58"></a><span class="w">    </span><span class="nd">@POST</span>
<a id="__codelineno-5-59" name="__codelineno-5-59" href="#__codelineno-5-59"></a><span class="w">    </span><span class="nd">@Path</span><span class="p">(</span><span class="s">"/{proposalId}/approve"</span><span class="p">)</span>
<a id="__codelineno-5-60" name="__codelineno-5-60" href="#__codelineno-5-60"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">approveProposal</span><span class="p">(</span>
<a id="__codelineno-5-61" name="__codelineno-5-61" href="#__codelineno-5-61"></a><span class="w">            </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"proposalId"</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span>
<a id="__codelineno-5-62" name="__codelineno-5-62" href="#__codelineno-5-62"></a><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-63" name="__codelineno-5-63" href="#__codelineno-5-63"></a>
<a id="__codelineno-5-64" name="__codelineno-5-64" href="#__codelineno-5-64"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-65" name="__codelineno-5-65" href="#__codelineno-5-65"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"reason"</span><span class="p">,</span><span class="w"> </span><span class="s">"Approved by human reviewer"</span><span class="p">);</span>
<a id="__codelineno-5-66" name="__codelineno-5-66" href="#__codelineno-5-66"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"approvedBy"</span><span class="p">,</span><span class="w"> </span><span class="s">"Workshop User"</span><span class="p">);</span>
<a id="__codelineno-5-67" name="__codelineno-5-67" href="#__codelineno-5-67"></a>
<a id="__codelineno-5-68" name="__codelineno-5-68" href="#__codelineno-5-68"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Approval request received for proposal %d by %s"</span><span class="p">,</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-69" name="__codelineno-5-69" href="#__codelineno-5-69"></a>
<a id="__codelineno-5-70" name="__codelineno-5-70" href="#__codelineno-5-70"></a><span class="w">            </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalService</span><span class="p">.</span><span class="na">processDecision</span><span class="p">(</span>
<a id="__codelineno-5-71" name="__codelineno-5-71" href="#__codelineno-5-71"></a><span class="w">                    </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-72" name="__codelineno-5-72" href="#__codelineno-5-72"></a>
<a id="__codelineno-5-73" name="__codelineno-5-73" href="#__codelineno-5-73"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">proposal</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-74" name="__codelineno-5-74" href="#__codelineno-5-74"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-75" name="__codelineno-5-75" href="#__codelineno-5-75"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">)</span>
<a id="__codelineno-5-76" name="__codelineno-5-76" href="#__codelineno-5-76"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-77" name="__codelineno-5-77" href="#__codelineno-5-77"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-78" name="__codelineno-5-78" href="#__codelineno-5-78"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-79" name="__codelineno-5-79" href="#__codelineno-5-79"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-5-80" name="__codelineno-5-80" href="#__codelineno-5-80"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-81" name="__codelineno-5-81" href="#__codelineno-5-81"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-82" name="__codelineno-5-82" href="#__codelineno-5-82"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-83" name="__codelineno-5-83" href="#__codelineno-5-83"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"Error approving proposal"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-5-84" name="__codelineno-5-84" href="#__codelineno-5-84"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-5-85" name="__codelineno-5-85" href="#__codelineno-5-85"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="s">"Error processing approval: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-86" name="__codelineno-5-86" href="#__codelineno-5-86"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-87" name="__codelineno-5-87" href="#__codelineno-5-87"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-88" name="__codelineno-5-88" href="#__codelineno-5-88"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-89" name="__codelineno-5-89" href="#__codelineno-5-89"></a>
<a id="__codelineno-5-90" name="__codelineno-5-90" href="#__codelineno-5-90"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-5-91" name="__codelineno-5-91" href="#__codelineno-5-91"></a><span class="cm">     * Reject a proposal.</span>
<a id="__codelineno-5-92" name="__codelineno-5-92" href="#__codelineno-5-92"></a><span class="cm">     * This is called when a human clicks the "Reject" button in the UI.</span>
<a id="__codelineno-5-93" name="__codelineno-5-93" href="#__codelineno-5-93"></a><span class="cm">     *</span>
<a id="__codelineno-5-94" name="__codelineno-5-94" href="#__codelineno-5-94"></a><span class="cm">     * @param proposalId The proposal ID</span>
<a id="__codelineno-5-95" name="__codelineno-5-95" href="#__codelineno-5-95"></a><span class="cm">     * @param request Request body containing reason and approvedBy</span>
<a id="__codelineno-5-96" name="__codelineno-5-96" href="#__codelineno-5-96"></a><span class="cm">     */</span>
<a id="__codelineno-5-97" name="__codelineno-5-97" href="#__codelineno-5-97"></a><span class="w">    </span><span class="nd">@POST</span>
<a id="__codelineno-5-98" name="__codelineno-5-98" href="#__codelineno-5-98"></a><span class="w">    </span><span class="nd">@Path</span><span class="p">(</span><span class="s">"/{proposalId}/reject"</span><span class="p">)</span>
<a id="__codelineno-5-99" name="__codelineno-5-99" href="#__codelineno-5-99"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">rejectProposal</span><span class="p">(</span>
<a id="__codelineno-5-100" name="__codelineno-5-100" href="#__codelineno-5-100"></a><span class="w">            </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"proposalId"</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span>
<a id="__codelineno-5-101" name="__codelineno-5-101" href="#__codelineno-5-101"></a><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-102" name="__codelineno-5-102" href="#__codelineno-5-102"></a>
<a id="__codelineno-5-103" name="__codelineno-5-103" href="#__codelineno-5-103"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-104" name="__codelineno-5-104" href="#__codelineno-5-104"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"reason"</span><span class="p">,</span><span class="w"> </span><span class="s">"Rejected by human reviewer"</span><span class="p">);</span>
<a id="__codelineno-5-105" name="__codelineno-5-105" href="#__codelineno-5-105"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"approvedBy"</span><span class="p">,</span><span class="w"> </span><span class="s">"Workshop User"</span><span class="p">);</span>
<a id="__codelineno-5-106" name="__codelineno-5-106" href="#__codelineno-5-106"></a>
<a id="__codelineno-5-107" name="__codelineno-5-107" href="#__codelineno-5-107"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Rejection request received for proposal %d by %s"</span><span class="p">,</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-108" name="__codelineno-5-108" href="#__codelineno-5-108"></a>
<a id="__codelineno-5-109" name="__codelineno-5-109" href="#__codelineno-5-109"></a><span class="w">            </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalService</span><span class="p">.</span><span class="na">processDecision</span><span class="p">(</span>
<a id="__codelineno-5-110" name="__codelineno-5-110" href="#__codelineno-5-110"></a><span class="w">                    </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-111" name="__codelineno-5-111" href="#__codelineno-5-111"></a>
<a id="__codelineno-5-112" name="__codelineno-5-112" href="#__codelineno-5-112"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">proposal</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-113" name="__codelineno-5-113" href="#__codelineno-5-113"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-114" name="__codelineno-5-114" href="#__codelineno-5-114"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">)</span>
<a id="__codelineno-5-115" name="__codelineno-5-115" href="#__codelineno-5-115"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-116" name="__codelineno-5-116" href="#__codelineno-5-116"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-117" name="__codelineno-5-117" href="#__codelineno-5-117"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-118" name="__codelineno-5-118" href="#__codelineno-5-118"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-5-119" name="__codelineno-5-119" href="#__codelineno-5-119"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-120" name="__codelineno-5-120" href="#__codelineno-5-120"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-121" name="__codelineno-5-121" href="#__codelineno-5-121"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-122" name="__codelineno-5-122" href="#__codelineno-5-122"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"Error rejecting proposal"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-5-123" name="__codelineno-5-123" href="#__codelineno-5-123"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-5-124" name="__codelineno-5-124" href="#__codelineno-5-124"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="s">"Error processing rejection: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-125" name="__codelineno-5-125" href="#__codelineno-5-125"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-126" name="__codelineno-5-126" href="#__codelineno-5-126"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-127" name="__codelineno-5-127" href="#__codelineno-5-127"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-128" name="__codelineno-5-128" href="#__codelineno-5-128"></a>
<a id="__codelineno-5-129" name="__codelineno-5-129" href="#__codelineno-5-129"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-5-130" name="__codelineno-5-130" href="#__codelineno-5-130"></a><span class="cm">     * Make a decision on a proposal with explicit KEEP_CAR or DISPOSE_CAR action.</span>
<a id="__codelineno-5-131" name="__codelineno-5-131" href="#__codelineno-5-131"></a><span class="cm">     * Simplified approach where the UI directly specifies the desired outcome.</span>
<a id="__codelineno-5-132" name="__codelineno-5-132" href="#__codelineno-5-132"></a><span class="cm">     *</span>
<a id="__codelineno-5-133" name="__codelineno-5-133" href="#__codelineno-5-133"></a><span class="cm">     * @param proposalId The proposal ID</span>
<a id="__codelineno-5-134" name="__codelineno-5-134" href="#__codelineno-5-134"></a><span class="cm">     * @param request Request body containing decision (KEEP_CAR or DISPOSE_CAR), reason, and approvedBy</span>
<a id="__codelineno-5-135" name="__codelineno-5-135" href="#__codelineno-5-135"></a><span class="cm">     */</span>
<a id="__codelineno-5-136" name="__codelineno-5-136" href="#__codelineno-5-136"></a><span class="w">    </span><span class="nd">@POST</span>
<a id="__codelineno-5-137" name="__codelineno-5-137" href="#__codelineno-5-137"></a><span class="w">    </span><span class="nd">@Path</span><span class="p">(</span><span class="s">"/{proposalId}/decide"</span><span class="p">)</span>
<a id="__codelineno-5-138" name="__codelineno-5-138" href="#__codelineno-5-138"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="nf">decideProposal</span><span class="p">(</span>
<a id="__codelineno-5-139" name="__codelineno-5-139" href="#__codelineno-5-139"></a><span class="w">            </span><span class="nd">@PathParam</span><span class="p">(</span><span class="s">"proposalId"</span><span class="p">)</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span>
<a id="__codelineno-5-140" name="__codelineno-5-140" href="#__codelineno-5-140"></a><span class="w">            </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-141" name="__codelineno-5-141" href="#__codelineno-5-141"></a>
<a id="__codelineno-5-142" name="__codelineno-5-142" href="#__codelineno-5-142"></a><span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-143" name="__codelineno-5-143" href="#__codelineno-5-143"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">"decision"</span><span class="p">);</span><span class="w"> </span><span class="c1">// KEEP_CAR or DISPOSE_CAR</span>
<a id="__codelineno-5-144" name="__codelineno-5-144" href="#__codelineno-5-144"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"reason"</span><span class="p">,</span><span class="w"> </span><span class="s">"Decision by human reviewer"</span><span class="p">);</span>
<a id="__codelineno-5-145" name="__codelineno-5-145" href="#__codelineno-5-145"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">approvedBy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">getOrDefault</span><span class="p">(</span><span class="s">"approvedBy"</span><span class="p">,</span><span class="w"> </span><span class="s">"Workshop User"</span><span class="p">);</span>
<a id="__codelineno-5-146" name="__codelineno-5-146" href="#__codelineno-5-146"></a>
<a id="__codelineno-5-147" name="__codelineno-5-147" href="#__codelineno-5-147"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">decision</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">decision</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">"KEEP_CAR"</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">decision</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="s">"DISPOSE_CAR"</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-148" name="__codelineno-5-148" href="#__codelineno-5-148"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-5-149" name="__codelineno-5-149" href="#__codelineno-5-149"></a><span class="w">                        </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="s">"Decision must be either KEEP_CAR or DISPOSE_CAR"</span><span class="p">))</span>
<a id="__codelineno-5-150" name="__codelineno-5-150" href="#__codelineno-5-150"></a><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-151" name="__codelineno-5-151" href="#__codelineno-5-151"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-5-152" name="__codelineno-5-152" href="#__codelineno-5-152"></a>
<a id="__codelineno-5-153" name="__codelineno-5-153" href="#__codelineno-5-153"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">infof</span><span class="p">(</span><span class="s">"Decision '%s' received for proposal %d by %s"</span><span class="p">,</span><span class="w"> </span><span class="n">decision</span><span class="p">,</span><span class="w"> </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-154" name="__codelineno-5-154" href="#__codelineno-5-154"></a>
<a id="__codelineno-5-155" name="__codelineno-5-155" href="#__codelineno-5-155"></a><span class="w">            </span><span class="c1">// Store the decision in the reason so the workflow can use it</span>
<a id="__codelineno-5-156" name="__codelineno-5-156" href="#__codelineno-5-156"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">fullReason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">": "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">reason</span><span class="p">;</span>
<a id="__codelineno-5-157" name="__codelineno-5-157" href="#__codelineno-5-157"></a>
<a id="__codelineno-5-158" name="__codelineno-5-158" href="#__codelineno-5-158"></a><span class="w">            </span><span class="c1">// We still use the approve/reject mechanism, but the decision is in the reason</span>
<a id="__codelineno-5-159" name="__codelineno-5-159" href="#__codelineno-5-159"></a><span class="w">            </span><span class="n">ApprovalProposal</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">approvalService</span><span class="p">.</span><span class="na">processDecision</span><span class="p">(</span>
<a id="__codelineno-5-160" name="__codelineno-5-160" href="#__codelineno-5-160"></a><span class="w">                    </span><span class="n">proposalId</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">fullReason</span><span class="p">,</span><span class="w"> </span><span class="n">approvedBy</span><span class="p">);</span>
<a id="__codelineno-5-161" name="__codelineno-5-161" href="#__codelineno-5-161"></a>
<a id="__codelineno-5-162" name="__codelineno-5-162" href="#__codelineno-5-162"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">ok</span><span class="p">(</span><span class="n">proposal</span><span class="p">).</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-163" name="__codelineno-5-163" href="#__codelineno-5-163"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalArgumentException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-164" name="__codelineno-5-164" href="#__codelineno-5-164"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">NOT_FOUND</span><span class="p">)</span>
<a id="__codelineno-5-165" name="__codelineno-5-165" href="#__codelineno-5-165"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-166" name="__codelineno-5-166" href="#__codelineno-5-166"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-167" name="__codelineno-5-167" href="#__codelineno-5-167"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IllegalStateException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-168" name="__codelineno-5-168" href="#__codelineno-5-168"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">)</span>
<a id="__codelineno-5-169" name="__codelineno-5-169" href="#__codelineno-5-169"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-170" name="__codelineno-5-170" href="#__codelineno-5-170"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-171" name="__codelineno-5-171" href="#__codelineno-5-171"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-172" name="__codelineno-5-172" href="#__codelineno-5-172"></a><span class="w">            </span><span class="n">Log</span><span class="p">.</span><span class="na">error</span><span class="p">(</span><span class="s">"Error processing decision"</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-5-173" name="__codelineno-5-173" href="#__codelineno-5-173"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Response</span><span class="p">.</span><span class="na">status</span><span class="p">(</span><span class="n">Response</span><span class="p">.</span><span class="na">Status</span><span class="p">.</span><span class="na">INTERNAL_SERVER_ERROR</span><span class="p">)</span>
<a id="__codelineno-5-174" name="__codelineno-5-174" href="#__codelineno-5-174"></a><span class="w">                    </span><span class="p">.</span><span class="na">entity</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">"error"</span><span class="p">,</span><span class="w"> </span><span class="s">"Error processing decision: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-5-175" name="__codelineno-5-175" href="#__codelineno-5-175"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-5-176" name="__codelineno-5-176" href="#__codelineno-5-176"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-177" name="__codelineno-5-177" href="#__codelineno-5-177"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-178" name="__codelineno-5-178" href="#__codelineno-5-178"></a><span class="p">}</span>
</code></pre></div>
<p><strong>REST API Endpoints:</strong></p>
<ul>
<li><code>GET /api/approvals/pending</code> - Returns all pending approval proposals</li>
<li><code>POST /api/approvals/{id}/approve</code> - Approve a proposal</li>
<li><code>POST /api/approvals/{id}/reject</code> - Reject a proposal</li>
</ul>
<div class="admonition success">
<p class="admonition-title">TRUE Human-in-the-Loop Implementation</p>
<ul>
<li>✅ Workflow execution <strong>actually pauses</strong> when approval is needed</li>
<li>✅ The workflow thread <strong>blocks</strong> on <code>CompletableFuture.get()</code></li>
<li>✅ Human sees pending approvals in the <strong>real-time UI</strong></li>
<li>✅ Human clicks <strong>Approve/Reject buttons</strong> in the UI</li>
<li>✅ The future <strong>completes</strong> with the human’s decision</li>
<li>✅ Workflow <strong>resumes</strong> and continues with the decision</li>
<li>✅ Includes <strong>timeout handling</strong> (5 minutes)</li>
<li>✅ Full <strong>audit trail</strong> in the database</li>
</ul>
</div>
<h3 id="update-the-fleetsupervisoragent">Update the FleetSupervisorAgent<a class="headerlink" href="#update-the-fleetsupervisoragent" title="Permanent link"></a></h3>
<p>Modify the supervisor to implement value-based routing with the approval workflow.</p>
<p>Update <code>src/main/java/com/carmanagement/agentic/agents/FleetSupervisorAgent.java</code>:</p>
<div class="highlight"><span class="filename">FleetSupervisorAgent.java</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.agentic.agents</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.agentic.declarative.SupervisorAgent</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">dev.langchain4j.agentic.declarative.SupervisorRequest</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="cm">/**</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="cm"> * Supervisor agent that orchestrates the entire car processing workflow.</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="cm"> * Coordinates feedback analysis agents and action agents based on car condition.</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="cm"> * Implements human-in-the-loop pattern for high-value vehicle dispositions.</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="hll"><span class="cm"> */</span>
</span><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">FleetSupervisorAgent</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">    </span><span class="nd">@SupervisorAgent</span><span class="p">(</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">        </span><span class="n">outputKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"supervisorDecision"</span><span class="p">,</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">        </span><span class="n">subAgents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">            </span><span class="n">PricingAgent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">            </span><span class="n">DispositionProposalAgent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">            </span><span class="n">HumanApprovalAgent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">            </span><span class="n">DispositionAgent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">            </span><span class="n">MaintenanceAgent</span><span class="p">.</span><span class="na">class</span><span class="p">,</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">            </span><span class="n">CleaningAgent</span><span class="p">.</span><span class="na">class</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="hll"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="nf">superviseCarProcessing</span><span class="p">(</span>
</span><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
</span><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
</span><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="hll"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
</span><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="hll"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
</span><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
</span><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="p">,</span>
</span><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cleaningFeedback</span><span class="p">,</span>
</span><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">maintenanceFeedback</span><span class="p">,</span>
</span><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cleaningRequest</span><span class="p">,</span>
</span><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">maintenanceRequest</span><span class="p">,</span>
</span><a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionRequest</span>
</span><a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">    </span><span class="nd">@SupervisorRequest</span><span class="p">()</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carMake</span><span class="p">,</span>
</span><a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carModel</span><span class="p">,</span>
</span><a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="hll"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">carYear</span><span class="p">,</span>
</span><a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="hll"><span class="w">        </span><span class="n">Integer</span><span class="w"> </span><span class="n">carNumber</span><span class="p">,</span>
</span><a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">carCondition</span><span class="p">,</span>
</span><a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">cleaningRequest</span><span class="p">,</span>
</span><a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="hll"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">maintenanceRequest</span><span class="p">,</span>
</span><a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionRequest</span><span class="p">,</span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">rentalFeedback</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a><span class="hll"><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a><span class="hll"><span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">dispositionRequired</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dispositionRequest</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">&amp;&amp;</span>
</span><a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a><span class="hll"><span class="w">                                     </span><span class="n">dispositionRequest</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">().</span><span class="na">contains</span><span class="p">(</span><span class="s">"DISPOSITION_REQUIRED"</span><span class="p">);</span>
</span><a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">noDispositionMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a><span class="s">            Disposition is not required. </span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="s">            Proceed with normal maintenance and cleaning workflow. </span>
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="s">            If cleaning or maintenance is required, invoke the appropriate agents.</span>
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="s">                """</span><span class="p">;</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a>
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="s">           DISPOSITION_REQUIRED</span>
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a>
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="s">           Follow these steps:</span>
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a>
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="s">           1. Get value from PricingAgent (keep $ format)</span>
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="s">           2. IF value &gt; $15,000 (HIGH-VALUE):</span>
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="s">              - Invoke DispositionProposalAgent → HumanApprovalAgent (workflow pauses)</span>
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="s">              - APPROVED: Use AI recommendation → KEEP→"KEEP_CAR", DISPOSE→"DISPOSE_CAR"</span>
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="s">              - REJECTED: Opposite of AI → KEEP→"DISPOSE_CAR", DISPOSE→"KEEP_CAR"</span>
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="s">           3. IF value ≤ $15,000 (LOW-VALUE):</span>
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="s">              - Invoke DispositionAgent directly</span>
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="s">              - KEEP→"KEEP_CAR", SCRAP/SELL/DONATE→"DISPOSE_CAR"</span>
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="s">           4. IF "KEEP_CAR": Invoke MaintenanceAgent/CleaningAgent as needed</span>
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="s">           CRITICAL: End with KEEP_CAR or DISPOSE_CAR</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="s">           """</span><span class="p">;</span>
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a>
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="s">            You are a fleet supervisor for a car rental company. You coordinate action agents based on feedback analysis.</span>
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a>
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="s">            The feedback has already been analyzed and you have these inputs:</span>
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a><span class="s">            - cleaningRequest: What cleaning is needed (or "CLEANING_NOT_REQUIRED")</span>
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a><span class="s">            - maintenanceRequest: What maintenance is needed (or "MAINTENANCE_NOT_REQUIRED")</span>
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="s">            - dispositionRequest: Whether severe damage requires disposition (or "DISPOSITION_NOT_REQUIRED")</span>
<a id="__codelineno-6-84" name="__codelineno-6-84" href="#__codelineno-6-84"></a>
<a id="__codelineno-6-85" name="__codelineno-6-85" href="#__codelineno-6-85"></a><span class="s">            Your job is to invoke the appropriate ACTION agents for this car</span>
<a id="__codelineno-6-86" name="__codelineno-6-86" href="#__codelineno-6-86"></a>
<a id="__codelineno-6-87" name="__codelineno-6-87" href="#__codelineno-6-87"></a><span class="s">            Car: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carYear</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carMake</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carModel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">" (#"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carNumber</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">")"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-88" name="__codelineno-6-88" href="#__codelineno-6-88"></a>
<a id="__codelineno-6-89" name="__codelineno-6-89" href="#__codelineno-6-89"></a><span class="s">            Current Condition: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">carCondition</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-90" name="__codelineno-6-90" href="#__codelineno-6-90"></a>
<a id="__codelineno-6-91" name="__codelineno-6-91" href="#__codelineno-6-91"></a><span class="s">            Rental Feedback: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rentalFeedback</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-92" name="__codelineno-6-92" href="#__codelineno-6-92"></a>
<a id="__codelineno-6-93" name="__codelineno-6-93" href="#__codelineno-6-93"></a><span class="s">            Cleaning Request: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cleaningRequest</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-94" name="__codelineno-6-94" href="#__codelineno-6-94"></a>
<a id="__codelineno-6-95" name="__codelineno-6-95" href="#__codelineno-6-95"></a><span class="s">            Maintenance Request: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maintenanceRequest</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"""</span>
<a id="__codelineno-6-96" name="__codelineno-6-96" href="#__codelineno-6-96"></a>
<a id="__codelineno-6-97" name="__codelineno-6-97" href="#__codelineno-6-97"></a><span class="s">            Disposition Request: """</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">dispositionRequired</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">dispositionMessage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">noDispositionMessage</span><span class="p">);</span>
<a id="__codelineno-6-98" name="__codelineno-6-98" href="#__codelineno-6-98"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-99" name="__codelineno-6-99" href="#__codelineno-6-99"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key Changes:</strong></p>
<ul>
<li>Added <strong>DispositionProposalAgent</strong> and <strong>HumanApprovalAgent</strong> to subAgents</li>
<li>Implemented <strong>two-path routing</strong> based on vehicle value</li>
<li>High-value path: Proposal → Approval → Execute if approved</li>
<li>Low-value path: Direct disposition decision</li>
<li>Stores approval status in AgenticScope for tracking</li>
</ul>
<h3 id="update-the-carconditions-model">Update the CarConditions Model<a class="headerlink" href="#update-the-carconditions-model" title="Permanent link"></a></h3>
<p>Add approval tracking fields to the data model.</p>
<p>Update <code>src/main/java/com/carmanagement/model/CarConditions.java</code>:</p>
<div class="highlight"><span class="filename">CarConditions.java</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">com.carmanagement.model</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cm">/**</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="cm"> * Record representing the conditions of a car.</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="cm"> *</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="cm"> * @param generalCondition    A description of the car's general condition</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="cm"> * @param carAssignment       Indicates the action required (DISPOSITION, MAINTENANCE, CLEANING, or NONE)</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="hll"><span class="cm"> * @param dispositionStatus   Status of disposition decision (DISPOSITION_APPROVED, DISPOSITION_REJECTED, or DISPOSITION_NOT_REQUIRED)</span>
</span><a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="hll"><span class="cm"> * @param dispositionReason   Reason for disposition decision</span>
</span><a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="cm"> */</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="hll"><span class="kd">public</span><span class="w"> </span><span class="kd">record</span> <span class="nc">CarConditions</span><span class="p">(</span>
</span><a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="hll"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">generalCondition</span><span class="p">,</span>
</span><a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="hll"><span class="w">    </span><span class="n">CarAssignment</span><span class="w"> </span><span class="n">carAssignment</span><span class="p">,</span>
</span><a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="hll"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionStatus</span><span class="p">,</span>
</span><a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="hll"><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">dispositionReason</span>
</span><a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="cm">     * Constructor for backward compatibility without disposition fields.</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="cm">     */</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="hll"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CarConditions</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">generalCondition</span><span class="p">,</span><span class="w"> </span><span class="n">CarAssignment</span><span class="w"> </span><span class="n">carAssignment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="hll"><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">generalCondition</span><span class="p">,</span><span class="w"> </span><span class="n">carAssignment</span><span class="p">,</span><span class="w"> </span><span class="s">"DISPOSITION_NOT_REQUIRED"</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
</span><a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="p">}</span>
</code></pre></div>
<p><strong>Key Points:</strong></p>
<ul>
<li>Added <code>approvalStatus</code> field (APPROVED/REJECTED/NOT_REQUIRED)</li>
<li>Added <code>approvalReason</code> field for audit trail</li>
<li>Backward-compatible constructor for existing code</li>
</ul>
<h3 id="update-application-configuration">Update Application Configuration<a class="headerlink" href="#update-application-configuration" title="Permanent link"></a></h3>
<p>Add configuration for the approval threshold.</p>
<p>Update <code>src/main/resources/application.properties</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Human-in-the-Loop configuration</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="c1"># Threshold for requiring human approval on high-value dispositions</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="na">car-management.approval.threshold</span><span class="o">=</span><span class="s">15000</span>
</code></pre></div>
<p>This makes the threshold configurable without code changes.</p>
<hr>
<h2 id="try-the-complete-solution">Try the Complete Solution<a class="headerlink" href="#try-the-complete-solution" title="Permanent link"></a></h2>
<p>Now let’s see the Human-in-the-Loop pattern in action!</p>
<div class="admonition warning">
<p class="admonition-title">Keep the Remote A2A Service Running</p>
<p>Before starting the step-06 application, make sure you have the <strong>remote A2A service from step-05</strong> running in a separate terminal.</p>
<p><strong>Why?</strong> The DispositionAgent used in this step is still running as a remote service (from step-05) and communicates via Agent-to-Agent (A2A) protocol.</p>
<p><strong>Port Configuration:</strong></p>
<ul>
<li>Remote A2A service (step-05): <code>http://localhost:8888</code></li>
<li>Main application (step-06): <code>http://localhost:8080</code></li>
</ul>
<p><strong>To start the remote service:</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nb">cd</span><span class="w"> </span>section-2/step-05/remote-a2a-agent
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>./mvnw<span class="w"> </span>quarkus:dev
</code></pre></div>
<p>Keep this terminal running while you work with step-06. Both services need to be running for the Human-in-the-Loop workflow to work correctly.</p>
</div>
<h3 id="start-the-application">Start the Application<a class="headerlink" href="#start-the-application" title="Permanent link"></a></h3>
<ol>
<li>Navigate to the step-06 directory:</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="nb">cd</span><span class="w"> </span>section-2/step-06
</code></pre></div>
<ol>
<li>Start the application:</li>
</ol>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked id="__tabbed_1_1" name="__tabbed_1" type="radio"><input id="__tabbed_1_2" name="__tabbed_1" type="radio"><div class="tabbed-labels"><label for="__tabbed_1_1">Linux / macOS</label><label for="__tabbed_1_2">Windows</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>./mvnw<span class="w"> </span>quarkus:dev
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>mvnw quarkus:dev
</code></pre></div>
</div>
</div>
</div>
<ol>
<li>Open <a href="http://localhost:8080" target="_blank">http://localhost:8080</a></li>
</ol>
<h3 id="test-hitl-scenarios">Test HITL Scenarios<a class="headerlink" href="#test-hitl-scenarios" title="Permanent link"></a></h3>
<p>Try these scenarios to see how the approval workflow handles different vehicle values:</p>
<h4 id="scenario-1-high-value-vehicle-requiring-approval">Scenario 1: High-Value Vehicle Requiring Approval<a class="headerlink" href="#scenario-1-high-value-vehicle-requiring-approval" title="Permanent link"></a></h4>
<p>Enter the following text in the feedback field for the <strong>Honda Civic</strong>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>The car was in a serious collision. Front end is completely destroyed and airbags deployed.
</code></pre></div>
<p><strong>What happens:</strong></p>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>flowchart TD
    Start([Input: Serious collision&lt;br/&gt;Front end destroyed])

    Start --&gt; FW[FeedbackWorkflow&lt;br/&gt;Detects: DISPOSITION_REQUIRED]

    FW --&gt; FSA[FleetSupervisorAgent&lt;br/&gt;Orchestration]
    FSA --&gt; PA[PricingAgent]
    PA --&gt; Value[Estimate: ~$18,000&lt;br/&gt;2020 Honda Civic]

    Value --&gt; Check{Value &gt; $15,000?}
    Check --&gt;|Yes| Proposal[DispositionProposalAgent&lt;br/&gt;Creates Proposal]
    Proposal --&gt; PropResult[Proposed: SCRAP&lt;br/&gt;Reasoning: Severe damage]

    PropResult --&gt; Human[HumanApprovalAgent&lt;br/&gt;Reviews Proposal]
    Human --&gt; Decision{Decision}
    Decision --&gt;|APPROVED| Execute[Execute SCRAP]
    Decision --&gt;|REJECTED| Fallback[Route to Maintenance]

    Execute --&gt; Result([Status: PENDING_DISPOSITION&lt;br/&gt;Approval: APPROVED])
    Fallback --&gt; Result2([Status: IN_MAINTENANCE&lt;br/&gt;Approval: REJECTED])

    style FW fill:#FAE5D3
    style FSA fill:#D5F5E3
    style PA fill:#F9E79F
    style Proposal fill:#FFD700
    style Human fill:#FF6B6B
    style Check fill:#FFA07A
    style Decision fill:#FFA07A
    style Result fill:#D2B4DE
    style Result2 fill:#D2B4DE</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<p><strong>Expected Result:</strong></p>
<ul>
<li>PricingAgent estimates value at ~$18,000 (above threshold)</li>
<li>DispositionProposalAgent creates SCRAP proposal</li>
<li>HumanApprovalAgent reviews and likely APPROVES (severe damage justifies scrapping)</li>
<li>Status: <code>PENDING_DISPOSITION</code></li>
<li>Condition includes approval status and reasoning</li>
</ul>
<h4 id="scenario-2-high-value-vehicle-approval-rejected">Scenario 2: High-Value Vehicle - Approval Rejected<a class="headerlink" href="#scenario-2-high-value-vehicle-approval-rejected" title="Permanent link"></a></h4>
<p>Enter the following text in the <strong>Mercedes Benz</strong> feedback field:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>Minor fender bender, small dent in rear bumper
</code></pre></div>
<p><strong>What happens:</strong></p>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>flowchart TD
    Start([Input: Minor fender bender&lt;br/&gt;small dent])

    Start --&gt; FW[FeedbackWorkflow&lt;br/&gt;Detects: DISPOSITION_REQUIRED]

    FW --&gt; FSA[FleetSupervisorAgent]
    FSA --&gt; PA[PricingAgent]
    PA --&gt; Value[Estimate: ~$25,000&lt;br/&gt;2021 Mercedes Benz]

    Value --&gt; Check{Value &gt; $15,000?}
    Check --&gt;|Yes| Proposal[DispositionProposalAgent&lt;br/&gt;Creates Proposal]
    Proposal --&gt; PropResult[Proposed: SELL or KEEP&lt;br/&gt;Minor damage]

    PropResult --&gt; Human[HumanApprovalAgent&lt;br/&gt;Reviews Proposal]
    Human --&gt; Decision[Decision: REJECTED&lt;br/&gt;Too valuable for minor damage]

    Decision --&gt; Fallback[Route to Maintenance&lt;br/&gt;Repair instead]
    Fallback --&gt; Result([Status: IN_MAINTENANCE&lt;br/&gt;Approval: REJECTED])

    style FW fill:#FAE5D3
    style FSA fill:#D5F5E3
    style PA fill:#F9E79F
    style Proposal fill:#FFD700
    style Human fill:#FF6B6B
    style Check fill:#FFA07A
    style Result fill:#D2B4DE</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<p><strong>Expected Result:</strong></p>
<ul>
<li>PricingAgent estimates value at ~$25,000 (high value)</li>
<li>DispositionProposalAgent suggests SELL or KEEP</li>
<li>HumanApprovalAgent REJECTS (too valuable for disposition with minor damage)</li>
<li>Fallback: Routes to MaintenanceAgent instead</li>
<li>Status: <code>IN_MAINTENANCE</code></li>
<li>Approval status: <code>REJECTED</code> with reasoning</li>
</ul>
<h4 id="scenario-3-low-value-vehicle-no-approval-needed">Scenario 3: Low-Value Vehicle - No Approval Needed<a class="headerlink" href="#scenario-3-low-value-vehicle-no-approval-needed" title="Permanent link"></a></h4>
<p>Enter the following text in the <strong>Ford F-150</strong> feedback field (Maintenance Returns tab):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>The truck is totaled, completely inoperable, very old
</code></pre></div>
<p><strong>What happens:</strong></p>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>flowchart TD
    Start([Input: Totaled truck&lt;br/&gt;very old])

    Start --&gt; FW[FeedbackWorkflow&lt;br/&gt;Detects: DISPOSITION_REQUIRED]

    FW --&gt; FSA[FleetSupervisorAgent]
    FSA --&gt; PA[PricingAgent]
    PA --&gt; Value[Estimate: ~$8,000&lt;br/&gt;2019 Ford F-150, totaled]

    Value --&gt; Check{Value &gt; $15,000?}
    Check --&gt;|No| Direct[DispositionAgent&lt;br/&gt;Direct Decision]
    Direct --&gt; Decision[Decision: SCRAP&lt;br/&gt;Beyond economical repair]

    Decision --&gt; Result([Status: PENDING_DISPOSITION&lt;br/&gt;Approval: NOT_REQUIRED])

    style FW fill:#FAE5D3
    style FSA fill:#D5F5E3
    style PA fill:#F9E79F
    style Direct fill:#87CEEB
    style Check fill:#FFA07A
    style Result fill:#D2B4DE</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<p><strong>Expected Result:</strong></p>
<ul>
<li>PricingAgent estimates value at ~$8,000 (below threshold)</li>
<li>Skips approval workflow (low value)</li>
<li>DispositionAgent makes direct SCRAP decision</li>
<li>Status: <code>PENDING_DISPOSITION</code></li>
<li>Approval status: <code>NOT_REQUIRED</code></li>
</ul>
<h3 id="check-the-logs">Check the Logs<a class="headerlink" href="#check-the-logs" title="Permanent link"></a></h3>
<p>Watch the console output to see the approval workflow execution:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>FeedbackWorkflow<span class="w"> </span>executing...
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">  </span>├─<span class="w"> </span>DispositionFeedbackAgent:<span class="w"> </span>DISPOSITION_REQUIRED
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>FleetSupervisorAgent<span class="w"> </span>orchestrating...
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">  </span>├─<span class="w"> </span>PricingAgent:<span class="w"> </span>Estimated<span class="w"> </span>value<span class="w"> </span><span class="nv">$18</span>,000
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">  </span>├─<span class="w"> </span>Value<span class="w"> </span>check:<span class="w"> </span><span class="nv">$18</span>,000<span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$15</span>,000<span class="w"> </span>→<span class="w"> </span>Approval<span class="w"> </span>required
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">  </span>├─<span class="w"> </span>DispositionProposalAgent:<span class="w"> </span>Proposed<span class="w"> </span>SCRAP
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">  </span>├─<span class="w"> </span>HumanApprovalAgent:<span class="w"> </span>Reviewing<span class="w"> </span>proposal...
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">  </span>└─<span class="w"> </span>Decision:<span class="w"> </span>APPROVED<span class="w"> </span>-<span class="w"> </span>Severe<span class="w"> </span>damage<span class="w"> </span>justifies<span class="w"> </span>scrapping
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a>CarConditionFeedbackAgent<span class="w"> </span>updating...
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">  </span>└─<span class="w"> </span>Approval<span class="w"> </span>status:<span class="w"> </span>APPROVED
</code></pre></div>
<p>Notice how high-value vehicles go through the proposal → approval → execution flow!</p>
<hr>
<h2 id="why-human-in-the-loop-matters">Why Human-in-the-Loop Matters<a class="headerlink" href="#why-human-in-the-loop-matters" title="Permanent link"></a></h2>
<h3 id="safety-and-control">Safety and Control<a class="headerlink" href="#safety-and-control" title="Permanent link"></a></h3>
<p>HITL provides a <strong>safety net</strong> for autonomous systems:</p>
<ul>
<li><strong>Prevents costly mistakes</strong>: Human review catches edge cases</li>
<li><strong>Builds trust</strong>: Gradual transition from manual to autonomous</li>
<li><strong>Maintains accountability</strong>: Clear human responsibility for critical decisions</li>
</ul>
<h3 id="compliance-and-audit">Compliance and Audit<a class="headerlink" href="#compliance-and-audit" title="Permanent link"></a></h3>
<p>Many industries require human oversight:</p>
<ul>
<li><strong>Financial services</strong>: Large transactions need approval</li>
<li><strong>Healthcare</strong>: Treatment decisions require physician review</li>
<li><strong>Legal</strong>: Contract terms need lawyer approval</li>
<li><strong>Audit trails</strong>: Track who approved what and when</li>
</ul>
<h3 id="balancing-automation-and-control">Balancing Automation and Control<a class="headerlink" href="#balancing-automation-and-control" title="Permanent link"></a></h3>
<p>HITL lets you <strong>tune the automation level</strong>:</p>
<div class="panzoom-box" data-key="alt" id="panzoom0" oncontextmenu="return false;">
    
    <nav class="panzoom-nav">
    <button class="panzoom-info panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M464 256A208 208 0 1 0 48 256a208 208 0 1 0 416 0zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm169.8-90.7c7.9-22.3 29.1-37.3 52.8-37.3l58.3 0c34.9 0 63.1 28.3 63.1 63.1c0 22.6-12.1 43.5-31.7 54.8L280 264.4c-.2 13-10.9 23.6-24 23.6c-13.3 0-24-10.7-24-24l0-13.5c0-8.6 4.6-16.5 12.1-20.8l44.3-25.4c4.7-2.7 7.6-7.7 7.6-13.1c0-8.4-6.8-15.1-15.1-15.1l-58.3 0c-3.4 0-6.4 2.1-7.5 5.3l-.4 1.2c-4.4 12.5-18.2 19-30.6 14.6s-19-18.2-14.6-30.6l.4-1.2zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z"></path>
    </svg>
</button><button class="panzoom-reset panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M125.7 160l50.3 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L48 224c-17.7 0-32-14.3-32-32L16 64c0-17.7 14.3-32 32-32s32 14.3 32 32l0 51.2L97.6 97.6c87.5-87.5 229.3-87.5 316.8 0s87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"></path>
    </svg>
</button><button class="panzoom-max panzoom-button">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z"></path>
    </svg>
</button><button class="panzoom-min panzoom-button panzoom-hidden">
    <svg class="panzoom-icon" viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg">
        <path d="M160 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96zM32 320c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM352 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 320c-17.7 0-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0z"></path>
    </svg>
</button>
    </nav>
    <pre class="mermaid"><code>graph LR
    A[Fully Manual] --&gt; B[HITL - High Threshold]
    B --&gt; C[HITL - Low Threshold]
    C --&gt; D[Fully Autonomous]

    style A fill:#FF6B6B
    style B fill:#FFD700
    style C fill:#87CEEB
    style D fill:#90EE90</code></pre> 
    <div class="panzoom-info-box panzoom-info-box-bottom panzoom-hidden">
Hold "Alt" / "Option" to enable pan &amp; zoom
</div>
</div>
<ul>
<li>Start with <strong>low threshold</strong> (approve everything)</li>
<li>Gradually <strong>increase threshold</strong> as confidence grows</li>
<li>Eventually move to <strong>fully autonomous</strong> for routine cases</li>
<li>Keep HITL for <strong>high-stakes decisions</strong></li>
</ul>
<hr>
<h2 id="optional-implement-it-yourself">Optional: Implement It Yourself<a class="headerlink" href="#optional-implement-it-yourself" title="Permanent link"></a></h2>
<p>If you want hands-on practice implementing the HITL pattern, you can build it step-by-step.</p>
<div class="admonition warning">
<p class="admonition-title">Short on time?</p>
<p>The complete solution is available in <code>section-2/step-06</code>.
You can explore the code there if you prefer to move forward quickly.</p>
</div>
<h3 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link"></a></h3>
<p>Before starting:</p>
<ul>
<li>Completed <a href="../step-05/" target="_blank">Step 05</a> (or have the <code>section-2/step-05/multi-agent-system</code> code available)</li>
<li>Application from Step 05 is stopped (Ctrl+C)</li>
</ul>
<h3 id="implementation-steps">Implementation Steps<a class="headerlink" href="#implementation-steps" title="Permanent link"></a></h3>
<ol>
<li><strong>Copy the step-05 code</strong> to create step-06 base</li>
<li><strong>Create DispositionProposalAgent.java</strong> with proposal generation logic</li>
<li><strong>Create HumanApprovalAgent.java</strong> with approval simulation</li>
<li><strong>Update FleetSupervisorAgent.java</strong> to add value-based routing</li>
<li><strong>Update CarConditions.java</strong> to add approval fields</li>
<li><strong>Update application.properties</strong> with approval threshold</li>
<li><strong>Test</strong> with different vehicle values</li>
</ol>
<p>Follow the code examples shown earlier in this guide.</p>
<hr>
<h2 id="experiment-further">Experiment Further<a class="headerlink" href="#experiment-further" title="Permanent link"></a></h2>
<h3 id="1-implement-real-human-approval">1. Implement Real Human Approval<a class="headerlink" href="#1-implement-real-human-approval" title="Permanent link"></a></h3>
<p>Replace the simulated HumanApprovalAgent with a real approval system:</p>
<ul>
<li>Store proposals in a database with PENDING status</li>
<li>Send email/Slack notifications to approvers</li>
<li>Create a web UI for reviewing proposals</li>
<li>Use async processing to wait for human response</li>
</ul>
<h3 id="2-add-approval-workflows">2. Add Approval Workflows<a class="headerlink" href="#2-add-approval-workflows" title="Permanent link"></a></h3>
<p>Implement multi-level approval:</p>
<ul>
<li><span class="arithmatex">\(15,000-\)</span>25,000: Single approver</li>
<li><span class="arithmatex">\(25,000-\)</span>50,000: Two approvers</li>
<li>
<blockquote>
<p>$50,000: Manager approval required</p>
</blockquote>
</li>
</ul>
<h3 id="3-track-approval-metrics">3. Track Approval Metrics<a class="headerlink" href="#3-track-approval-metrics" title="Permanent link"></a></h3>
<p>Add monitoring:</p>
<ul>
<li>Approval rate by value range</li>
<li>Average approval time</li>
<li>Rejection reasons analysis</li>
<li>Approver performance metrics</li>
</ul>
<h3 id="4-implement-approval-timeouts">4. Implement Approval Timeouts<a class="headerlink" href="#4-implement-approval-timeouts" title="Permanent link"></a></h3>
<p>Add time limits:</p>
<ul>
<li>Auto-reject after 24 hours</li>
<li>Escalate to manager after 48 hours</li>
<li>Send reminder notifications</li>
</ul>
<h3 id="5-add-approval-history">5. Add Approval History<a class="headerlink" href="#5-add-approval-history" title="Permanent link"></a></h3>
<p>Track all approvals:</p>
<ul>
<li>Who approved/rejected</li>
<li>When the decision was made</li>
<li>Reasoning provided</li>
<li>Outcome of the decision</li>
</ul>
<hr>
<h2 id="troubleshooting">Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permanent link"></a></h2>
<details class="warning">
<summary>All vehicles going through approval workflow</summary>
<p>Check that the value threshold is correctly configured in <code>application.properties</code> and that the PricingAgent is returning numeric values that can be compared.</p>
</details>
<details class="warning">
<summary>Approval agent always approving/rejecting</summary>
<p>Review the approval criteria in HumanApprovalAgent’s system message. The simulated logic may need adjustment based on your test scenarios.</p>
</details>
<details class="warning">
<summary>Approval status not being tracked</summary>
<p>Verify that:</p>
<ul>
<li>FleetSupervisorAgent stores <code>approvalStatus</code> and <code>approvalReason</code> in AgenticScope</li>
<li>CarConditions model has the new fields</li>
<li>CarProcessingWorkflow retrieves these values from the scope</li>
</ul>
</details>
<details class="warning">
<summary>Low-value vehicles still requiring approval</summary>
<p>Check the value comparison logic in FleetSupervisorAgent. Ensure the PricingAgent output is being parsed correctly as a number.</p>
</details>
<hr>
<h2 id="whats-next">What’s Next?<a class="headerlink" href="#whats-next" title="Permanent link"></a></h2>
<p>Congratulations! You’ve completed the final step of Section 2 and implemented the <strong>Human-in-the-Loop pattern</strong> for safe, controlled autonomous decision-making!</p>
<p>The system now:</p>
<ul>
<li>Routes high-value vehicles through human approval</li>
<li>Creates proposals for human review</li>
<li>Tracks approval decisions for audit trails</li>
<li>Provides fallback paths for rejected proposals</li>
<li>Balances automation with human oversight</li>
</ul>
<p>Ready to wrap up? Head to the conclusion to review everything you’ve learned and see how these patterns apply to real-world scenarios!</p>
<p><a href="../conclusion/">Continue to Conclusion - Mastering Agentic Systems</a></p></div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../step-05/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Step 5 - Using remote agents (A2A)">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Step 5 - Using remote agents (A2A)
              </div>
            </div>
          </a>
        
        
          
          <a href="../conclusion/" class="md-footer__link md-footer__link--next" aria-label="Next: Mastering Agentic Systems">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Mastering Agentic Systems
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2022 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information, adapter to have the Red Hat footer -->
<div class="md-copyright">
    <div class="md-copyright__highlight">
        <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> |
        <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
    
    Made with
    <a
            href="https://squidfunk.github.io/mkdocs-material/"
            target="_blank" rel="noopener"
    >
        Material for MkDocs
    </a>
    
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.sections", "content.tabs.link", "content.code.annotate", "navigation.instant", "navigation.indexes", "navigation.tracking", "navigation.footer", "navigation.tabs.sticky", "content.code.select", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../assets/javascripts/panzoom.min.js"></script>
      
        <script src="../../assets/javascripts/zoompan.js"></script>
      
    
  </body>
</html>